# 中文指南（最新逻辑框架与函数说明）

本文档总结当前 `zotero-mcp` 的最新逻辑框架与主要函数实现，适合快速理解系统边界与调用路径。

**核心目标**
- 对齐 `logseq-mcp` 的 MCP 入口与 Handler 架构。
- 移除 RSS/Gmail 采集，仅保留 Zotero 核心能力与 PDF 分析能力。
- 所有功能集中于单一包 `src/zotero_mcp`。

**入口与运行模式**
- MCP 入口：`src/zotero_mcp/server.py`，使用 MCP SDK 的 `Server` + `stdio`。
- 工具注册入口：`src/zotero_mcp/app.py`，FastMCP 仅用于工具注册与工具目录。
- CLI 入口：`src/zotero_mcp/cli.py`，`serve` 默认 stdio。

## 目录结构（关键层）

```
src/zotero_mcp
├── app.py        FastMCP 工具注册入口
├── server.py     MCP stdio 入口（logseq 风格）
├── cli.py        CLI 入口
├── handlers/     MCP Tool/Prompt 处理层
├── tools/        MCP 工具定义（FastMCP @mcp.tool）
├── services/     业务逻辑与工作流
├── clients/      外部 API 与模型客户端
├── analyzer/     PDF 解析与 LLM 分析
├── models/       Pydantic 输入/输出模型
├── settings.py   Pydantic Settings（env）
└── utils/        配置/日志/格式化/异步工具
```

## 调用路径（标准）

```
MCP Client -> server.py -> handlers -> tools -> services -> clients -> 外部 API
```

## 入口函数实现

| 文件 | 函数 | 说明 |
| --- | --- | --- |
| `src/zotero_mcp/app.py` | `get_fastmcp_app()` | 创建 FastMCP 实例并注册全部工具（单例） |
| `src/zotero_mcp/app.py` | `mcp` | 共享的 FastMCP 实例 |
| `src/zotero_mcp/server.py` | `serve()` | MCP stdio 服务器启动流程 |
| `src/zotero_mcp/server.py` | `run()` | `asyncio.run(serve())` |
| `src/zotero_mcp/cli.py` | `main()` | CLI 入口，`serve` 使用 stdio |

## Handler 层实现

| 文件 | 函数/方法 | 说明 |
| --- | --- | --- |
| `src/zotero_mcp/handlers/tools.py` | `ToolHandler.get_tools()` | 从 FastMCP 工具表生成 MCP Tool 列表 |
| `src/zotero_mcp/handlers/tools.py` | `ToolHandler.handle_tool()` | 调用 FastMCP 工具并返回 MCP 内容块 |
| `src/zotero_mcp/handlers/prompts.py` | `PromptHandler.get_prompts()` | 返回全部 Prompt（含 alias） |
| `src/zotero_mcp/handlers/prompts.py` | `PromptHandler.handle_prompt()` | 统一生成 “调用工具+参数 JSON” 的 Prompt |

## MCP Tools（按模块归类）

### Search & Discovery（`src/zotero_mcp/tools/search.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_search` | 关键词搜索（标题/作者/年份/全文） |
| `zotero_search_by_tag` | 标签包含/排除搜索 |
| `zotero_advanced_search` | 多条件组合检索 |
| `zotero_semantic_search` | 语义检索（向量检索） |
| `zotero_get_recent` | 最近添加条目 |

### Items（`src/zotero_mcp/tools/items.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_get_metadata` | 获取条目元数据 |
| `zotero_get_fulltext` | 获取全文内容 |
| `zotero_get_children` | 获取附件与笔记 |
| `zotero_get_collections` | 列出收藏集或收藏集内条目 |
| `zotero_get_bundle` | 获取条目综合包（元数据/全文/笔记/批注） |

### Notes & Annotations（`src/zotero_mcp/tools/annotations.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_get_annotations` | 获取 PDF 批注 |
| `zotero_get_notes` | 获取条目笔记 |
| `zotero_search_notes` | 搜索笔记与批注 |
| `zotero_create_note` | 创建笔记 |

### Collections（`src/zotero_mcp/tools/collections.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_create_collection` | 创建收藏集 |
| `zotero_delete_collection` | 删除收藏集 |
| `zotero_move_collection` | 移动收藏集 |
| `zotero_rename_collection` | 重命名收藏集 |

### Database（`src/zotero_mcp/tools/database.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_update_database` | 语义检索数据库更新 |
| `zotero_database_status` | 语义数据库状态 |

### Batch（`src/zotero_mcp/tools/batch.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_batch_get_metadata` | 批量获取元数据 |

### Workflow（`src/zotero_mcp/tools/workflow.py`）
| Tool 名称 | 说明 |
| --- | --- |
| `zotero_prepare_analysis` | 准备分析数据（模式 A） |
| `zotero_batch_analyze_pdfs` | 批量分析（模式 B） |
| `zotero_resume_workflow` | 继续中断工作流 |
| `zotero_list_workflows` | 列出工作流 |
| `zotero_find_collection` | 按名称查找收藏集 |

## 业务服务（核心逻辑）

| 模块 | 关键职责 |
| --- | --- |
| `services/data_access.py` | 统一数据访问入口（本地 DB / Web API） |
| `services/workflow.py` | 批量分析工作流、断点续传与状态管理 |
| `services/scanner.py` | 扫描与处理未分析条目 |
| `services/checkpoint.py` | 工作流检查点（保存/恢复） |
| `services/zotero/search_service.py` | Zotero 搜索逻辑 |
| `services/zotero/item_service.py` | 条目详情、附件、笔记等业务聚合 |
| `services/zotero/metadata_service.py` | DOI/元数据补全（Crossref/OpenAlex） |
| `services/zotero/metadata_update_service.py` | 批量元数据更新 |
| `services/zotero/semantic_search.py` | 语义检索与索引维护 |
| `services/zotero/duplicate_service.py` | 重复检测与移动处理 |

## Prompt 列表（中英文对照）

详见 `docs/PROMPTS.md`，已覆盖所有工具对应的 Prompt，并提供 alias 说明。

## 配置与环境

| 文件 | 说明 |
| --- | --- |
| `src/zotero_mcp/settings.py` | Pydantic Settings（环境变量入口） |
| `src/zotero_mcp/utils/config/` | 配置读取、日志系统 |

## 关键原则

- 仅保留 Zotero 核心能力与 PDF 分析能力。
- MCP 入口与 Handler 架构对齐 `logseq-mcp`。
- 工具层（FastMCP）仅负责工具定义，MCP SDK 负责传输与协议。
