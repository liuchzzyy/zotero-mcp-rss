# 中文指南（最新逻辑框架与函数说明）

本文档总结当前 `zotero-mcp` 的最新逻辑框架与主要函数实现，适合快速理解系统边界与调用路径。

**核心目标**
- 对齐 `logseq-mcp` 的 MCP 入口与 Handler 架构。
- 所有功能集中于单一包 `src/zotero_mcp`。

**入口与运行模式**
- MCP 入口：`src/zotero_mcp/server.py`，使用 MCP SDK 的 `Server` + `stdio`。
- 工具注册入口：`src/zotero_mcp/server.py`，工具定义集中在 `handlers/tools.py`。
- CLI 入口：`src/zotero_mcp/cli.py`，`serve` 默认 stdio。

## 目录结构（关键层）

```
src/zotero_mcp
├── server.py          MCP stdio 入口（logseq 风格）
├── cli.py             CLI 入口（serve/setup/scan/update-db/deduplicate 等）
├── settings.py        Pydantic Settings（env 配置，功能开关）
├── config.py          运行时配置管理
├── handlers/          MCP Tool/Prompt 处理层
│   ├── tools.py       ToolHandler（工具定义 + match/case 分发）
│   └── prompts.py     PromptHandler（Prompt 定义 + alias）
├── services/          业务逻辑与工作流
│   ├── data_access.py 统一数据访问入口（本地 DB / Web API）
│   ├── workflow.py    批量分析工作流（断点续传）
│   ├── scanner.py     全局扫描与处理
│   ├── checkpoint.py  工作流检查点管理
│   ├── note_parser.py 笔记解析
│   ├── note_renderer.py 笔记渲染
│   ├── analysis_status.py 分析状态管理
│   ├── common/        公共服务（retry 等）
│   └── zotero/        Zotero 领域服务
│       ├── item_service.py      条目 CRUD
│       ├── search_service.py    搜索逻辑
│       ├── metadata_service.py  DOI/元数据补全
│       ├── metadata_update_service.py 批量元数据更新
│       ├── semantic_search.py   语义检索与索引
│       └── duplicate_service.py 重复检测与处理
├── clients/           外部 API 客户端
│   ├── zotero/        Zotero API + 本地 DB + PDF 提取 + Markdown 转换
│   ├── database/      ChromaDB 向量数据库
│   ├── metadata/      Crossref + OpenAlex API
│   └── llm/           LLM 提供商（base/cli/capabilities）
├── models/            Pydantic 数据模型
│   ├── enums.py       工具名称枚举（ToolName）
│   ├── schemas.py     工具输入模型聚合（所有 Input 模型的统一导出）
│   ├── responses.py   响应格式化器（Formatters）
│   ├── common/        通用响应模型（BaseInput/BaseResponse/SearchResponse 等）
│   ├── zotero/        条目/收藏集/批注/笔记结构模型
│   ├── search/        搜索查询模型
│   ├── workflow/      工作流/批处理模型
│   ├── database/      语义搜索模型
│   └── ai/            AI 分析相关模型
├── integration/       集成层
│   ├── zotero_integration.py   Zotero 集成包装
│   └── analyzer_integration.py 分析器集成包装
├── input/             外部输入适配
│   └── paper_feed.py  paper-feed Zotero 适配器
├── analyzer/          PDF 解析与 LLM 分析管线
│   ├── analyzers/     PDF 分析器
│   ├── clients/       分析器 LLM 客户端（OpenAI 等）
│   ├── extractors/    PDF 内容提取
│   ├── models/        分析器数据模型
│   └── templates/     分析模板管理
├── formatters/        输出格式化器
│   ├── base.py        格式化器基类
│   ├── markdown.py    Markdown 格式化
│   └── json_formatter.py JSON 格式化
└── utils/             工具函数库
    ├── config/        配置读取 + 日志系统
    ├── data/          数据映射 + 模板
    ├── formatting/    文本格式化 + 美化 + Markdown
    ├── async_helpers/ 异步批量加载 + 缓存
    ├── system/        系统工具（setup/updater/errors）
    └── errors.py      统一错误格式化
```

## 调用路径（标准）

```
MCP Client -> server.py -> handlers/tools.py -> services -> clients -> 外部 API
```

## 入口函数实现

| 文件 | 函数 | 说明 |
| --- | --- | --- |
| `server.py` | `serve()` | MCP stdio 服务器启动，注册 ToolHandler + PromptHandler |
| `server.py` | `run()` | `asyncio.run(serve())` |
| `cli.py` | `main()` | CLI 入口，支持 serve/setup/scan/update-db/db-status/db-inspect/update/update-metadata/deduplicate/version/setup-info 等子命令 |

## 配置与功能开关

`settings.py` 使用 Pydantic Settings，从环境变量加载配置：

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `server_name` | `"zotero-mcp"` | MCP 服务器名称 |
| `enable_semantic_search` | `True` | 启用语义搜索工具 |
| `enable_workflows` | `True` | 启用工作流工具 |
| `enable_database_tools` | `True` | 启用数据库管理工具 |
| `enable_collection_tools` | `True` | 启用收藏集管理工具 |

环境变量前缀为 `ZOTERO_`（如 `ZOTERO_ENABLE_SEMANTIC_SEARCH=false`）。

## Handler 层实现

| 文件 | 函数/方法 | 说明 |
| --- | --- | --- |
| `handlers/tools.py` | `ToolHandler.get_tools()` | 根据功能开关动态生成 MCP Tool 列表 |
| `handlers/tools.py` | `ToolHandler.handle_tool()` | 使用 `match/case` 分发工具调用到对应服务 |
| `handlers/prompts.py` | `PromptHandler.get_prompts()` | 返回全部 Prompt（含 alias） |
| `handlers/prompts.py` | `PromptHandler.handle_prompt()` | 统一生成 "调用工具+参数 JSON" 的 Prompt |

### 工具注册机制

`ToolHandler.get_tools()` 按以下逻辑注册工具：

1. **核心工具**（始终注册）：Search、Content Access、Annotations & Notes、Batch
2. **条件注册**：
   - `enable_semantic_search` → `zotero_semantic_search`
   - `enable_collection_tools` → 收藏集 CRUD 工具
   - `enable_database_tools` → 数据库更新/状态工具
   - `enable_workflows` → 批量分析/工作流工具

## MCP Tools（按模块归类）

### Search & Discovery
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_search` | 始终 | 关键词搜索（标题/作者/年份/全文） |
| `zotero_search_by_tag` | 始终 | 标签包含/排除搜索 |
| `zotero_advanced_search` | 始终 | 多条件组合检索 |
| `zotero_semantic_search` | `enable_semantic_search` | 语义检索（向量检索） |
| `zotero_get_recent` | 始终 | 最近添加条目 |

### Content Access
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_get_metadata` | 始终 | 获取条目元数据 |
| `zotero_get_fulltext` | 始终 | 获取全文内容 |
| `zotero_get_children` | 始终 | 获取附件与笔记 |
| `zotero_get_collections` | 始终 | 列出收藏集或收藏集内条目 |
| `zotero_get_bundle` | 始终 | 获取条目综合包（元数据/全文/笔记/批注） |

### Annotations & Notes
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_get_annotations` | 始终 | 获取 PDF 批注 |
| `zotero_get_notes` | 始终 | 获取条目笔记 |
| `zotero_search_notes` | 始终 | 搜索笔记与批注 |
| `zotero_create_note` | 始终 | 创建笔记 |

### Collections
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_create_collection` | `enable_collection_tools` | 创建收藏集 |
| `zotero_delete_collection` | `enable_collection_tools` | 删除收藏集 |
| `zotero_move_collection` | `enable_collection_tools` | 移动收藏集 |
| `zotero_rename_collection` | `enable_collection_tools` | 重命名收藏集 |

### Database
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_update_database` | `enable_database_tools` | 语义检索数据库更新 |
| `zotero_database_status` | `enable_database_tools` | 语义数据库状态 |

### Batch
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_batch_get_metadata` | 始终 | 批量获取元数据 |

### Workflow
| Tool 名称 | 条件 | 说明 |
| --- | --- | --- |
| `zotero_prepare_analysis` | `enable_workflows` | 准备分析数据（模式 A） |
| `zotero_batch_analyze_pdfs` | `enable_workflows` | 批量分析（模式 B，支持多模态） |
| `zotero_resume_workflow` | `enable_workflows` | 继续中断工作流 |
| `zotero_list_workflows` | `enable_workflows` | 列出工作流 |
| `zotero_find_collection` | `enable_workflows` | 按名称查找收藏集（模糊匹配） |

## CLI 子命令

| 命令 | 说明 |
| --- | --- |
| `serve` | 启动 MCP stdio 服务器（默认命令） |
| `setup` | 配置 zotero-mcp（支持 `--no-local`、`--api-key`、`--semantic-config-only`） |
| `update-db` | 更新语义搜索数据库（`--fulltext`、`--force-rebuild`、`--scan-limit`、`--treated-limit`） |
| `db-status` | 查看数据库状态 |
| `db-inspect` | 检查已索引文档（`--stats`、`--show-documents`、`--filter`） |
| `scan` | 扫描并分析未处理论文（支持多模态、LLM 提供商选择） |
| `update-metadata` | 批量从 Crossref/OpenAlex 更新元数据 |
| `deduplicate` | 重复检测与移动处理（`--dry-run`、`--trash-collection`） |
| `update` | 更新 zotero-mcp 版本 |
| `version` | 显示版本信息 |
| `setup-info` | 显示安装与配置信息 |

## 业务服务（核心逻辑）

| 模块 | 关键职责 |
| --- | --- |
| `services/data_access.py` | 统一数据访问入口（本地 DB / Web API），自动选择后端 |
| `services/workflow.py` | 批量分析工作流、断点续传与状态管理 |
| `services/scanner.py` | 全局扫描与处理未分析条目（CLI `scan` 命令后端） |
| `services/checkpoint.py` | 工作流检查点（保存/恢复） |
| `services/note_parser.py` | 笔记内容解析 |
| `services/note_renderer.py` | 笔记 HTML 渲染 |
| `services/analysis_status.py` | 分析状态跟踪 |
| `services/common/retry.py` | 通用重试逻辑 |
| `services/zotero/item_service.py` | 条目详情、附件、笔记等业务聚合 |
| `services/zotero/search_service.py` | Zotero 搜索逻辑 |
| `services/zotero/metadata_service.py` | DOI/元数据补全（Crossref/OpenAlex） |
| `services/zotero/metadata_update_service.py` | 批量元数据更新 |
| `services/zotero/semantic_search.py` | 语义检索与索引维护 |
| `services/zotero/duplicate_service.py` | 重复检测与移动处理 |

## 客户端层

| 模块 | 说明 |
| --- | --- |
| `clients/zotero/api_client.py` | Zotero Web API 客户端（含 429 重试） |
| `clients/zotero/local_db.py` | Zotero 本地 SQLite 数据库读取 |
| `clients/zotero/pdf_extractor.py` | PDF 文本/图片/表格提取 |
| `clients/zotero/markdown_converter.py` | Markdown 格式转换 |
| `clients/database/chroma.py` | ChromaDB 向量数据库客户端 |
| `clients/metadata/crossref.py` | Crossref API 客户端 |
| `clients/metadata/openalex.py` | OpenAlex API 客户端 |
| `clients/llm/base.py` | LLM 基础客户端（DeepSeek/OpenAI/Gemini） |
| `clients/llm/cli.py` | Claude CLI LLM 客户端 |
| `clients/llm/capabilities.py` | LLM 能力注册表（视觉支持等） |

## 模型层

| 模块 | 说明 |
| --- | --- |
| `models/enums.py` | `ToolName` 枚举（所有工具名称） |
| `models/schemas.py` | 工具输入模型统一导出 |
| `models/responses.py` | `Formatters` 响应格式化器 |
| `models/common/` | `BaseInput`、`BaseResponse`、`SearchResponse`、`BundleResponse` 等 |
| `models/zotero/items.py` | 条目输入模型（GetMetadata/GetFulltext/GetBundle 等） |
| `models/zotero/annotations.py` | 批注输入模型 |
| `models/zotero/collections.py` | 收藏集输入模型 |
| `models/zotero/note_structure.py` | 笔记结构模型 |
| `models/search/queries.py` | 搜索查询模型 |
| `models/workflow/analysis.py` | 分析工作流模型 |
| `models/workflow/batch.py` | 批处理模型 |
| `models/database/semantic.py` | 语义搜索模型 |
| `models/ai/schemas.py` | AI 分析相关模型 |

## 集成层

| 模块 | 说明 |
| --- | --- |
| `integration/zotero_integration.py` | Zotero 服务集成包装 |
| `integration/analyzer_integration.py` | PDF 分析器集成包装 |

## 分析器管线（analyzer/）

| 子模块 | 说明 |
| --- | --- |
| `analyzer/analyzers/pdf_analyzer.py` | PDF 分析器主逻辑 |
| `analyzer/clients/openai_client.py` | 分析器 OpenAI 客户端 |
| `analyzer/extractors/pdf_extractor.py` | PDF 内容提取器 |
| `analyzer/models/` | 分析器模型（checkpoint/content/result/template） |
| `analyzer/templates/template_manager.py` | 分析模板管理器 |

## Prompt 列表

### Alias（便捷别名）

| Prompt 名称 | 对应工具 | 说明 |
| --- | --- | --- |
| `zotero_search_items` | `zotero_search` | 关键词搜索别名 |
| `zotero_get_item` | `zotero_get_metadata` | 获取元数据别名 |
| `zotero_analyze_paper` | `zotero_batch_analyze_pdfs` | PDF 分析别名 |

### 完整 Prompt 列表

所有 MCP Tool 均有对应 Prompt 定义（参数与 Tool 一一对应），`PromptHandler.handle_prompt()` 统一将 Prompt 转换为 "调用工具 + 参数 JSON" 的消息格式。

## 批量操作参数

### `scan_limit` 与 `treated_limit`

| 参数 | 用途 | 默认值 |
| --- | --- | --- |
| `scan_limit` | 每批从 Zotero API 获取的条目数 | 因命令而异 (100-500) |
| `treated_limit` | 实际处理的最大条目数（不含跳过项） | 因命令而异 (1-1000) |

**扫描逻辑**：
1. 按收藏集依次扫描，每次获取 `scan_limit` 条
2. 跳过已有特定标签的条目（不计入 `treated_limit`）
3. 达到 `treated_limit` 后停止所有扫描

**各命令差异**：

| 命令 | 跳过标签 | treated_limit 含义 |
| --- | --- | --- |
| `scan` | "AI分析" | 需要 AI 分析的条目数 |
| `update-metadata` | "AI元数据" | 需要元数据更新的条目数 |
| `deduplicate` | 无 | 发现的重复条目数 |

## 多模态 PDF 分析

### LLM 提供商能力

| 提供商 | 视觉支持 | 适用场景 |
| --- | --- | --- |
| `claude-cli` | 有 | 含图表/公式的论文 |
| `deepseek` | 无 | 纯文本，快速/低成本 |
| `openai` | 有 | OpenAI GPT-4 Vision |
| `gemini` | 有 | Google Gemini Vision |
| `auto` | 自动选择 | 根据 PDF 内容智能选择 |

### 自动选择逻辑（`auto`）

1. PDF 含图片/表格 → 选择支持视觉的 LLM（优先 `claude-cli`）
2. PDF 纯文本 → 选择 `deepseek`（快速/低成本）
3. 优选 LLM 不可用时 → 降级到可用选项

### CLI 使用示例

```bash
# 自动选择 LLM
zotero-mcp scan --llm-provider auto --multimodal

# 强制使用 Claude CLI
zotero-mcp scan --llm-provider claude-cli --multimodal

# 纯文本分析
zotero-mcp scan --llm-provider deepseek --no-multimodal

# 指定收藏集和限制
zotero-mcp scan -c "00_INBOXS" --treated-limit 10 --llm-provider auto
```

## 配置与环境

| 文件 | 说明 |
| --- | --- |
| `settings.py` | Pydantic Settings（环境变量入口，功能开关） |
| `config.py` | 运行时配置管理 |
| `utils/config/config.py` | 配置文件读取 |
| `utils/config/logging.py` | 日志系统初始化 |
| `utils/errors.py` | 统一错误格式化 |
| `utils/system/errors.py` | 系统级错误处理 |
| `utils/system/setup.py` | 交互式 setup 流程 |
| `utils/system/updater.py` | 版本更新逻辑 |

**配置优先级**：环境变量 > `~/.config/zotero-mcp/config.json` > 默认值

## 关键架构原则

1. **分层架构**：Entry → Handlers → Services → Clients
2. **领域组织**：每层按领域/用途子目录组织
3. **服务优先**：工具层只做参数解析和格式化，业务逻辑在服务层
4. **全异步**：所有 I/O 必须使用 `async/await`
5. **类型安全**：使用 Pydantic 模型进行数据验证
6. **功能开关**：通过 `settings.py` 控制工具注册
7. **绝对导入**：始终使用 `from zotero_mcp.xxx import ...`
8. **统一错误处理**：`utils/errors.py` 提供 `format_error()` 统一异常格式

## 数据流模式

- **Tools → Services → Clients**：工具层委托服务层，服务层协调客户端
- **后端选择**：`DataAccessService` 自动选择本地 DB（快速读取）或 Zotero API（写入/回退）
- **工作流检查点**：`WorkflowService` 使用 `CheckpointService` 实现可断点续传的批处理
- **响应格式化**：`Formatters.format_response()` 根据 `response_format` 参数输出 Markdown 或 JSON
