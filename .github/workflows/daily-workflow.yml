name: Daily Research Workflow (RSS + Gmail)

# Schedule: Run daily at 3:00 AM Beijing Time (UTC 19:00 previous day)
on:
  push:
    branches:
      - feat/gmail-integration
  schedule:
    - cron: '0 19 * * *'

  # Manual triggering
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run'
        required: true
        type: choice
        options:
          - all
          - rss-only
          - gmail-only
        default: all
      dry_run:
        description: 'Preview only (no changes)'
        required: false
        type: boolean
        default: false
      debug:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: RSS Feed Processing
  rss-process:
    if: always() && (github.event_name == 'schedule' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.job == 'all' || inputs.job == 'rss-only')))
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        run: uv sync --locked

      - name: Cache RSS Keywords
        uses: actions/cache@v4
        with:
          path: RSS/keywords_cache.json
          key: rss-keywords-${{ hashFiles('RSS/prompt.txt') }}
          restore-keys: |
            rss-keywords-

      - name: Process RSS Feeds
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          RSS_PROMPT: ${{ secrets.RSS_PROMPT }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "=== RSS Processing ==="
          echo "Time: $(date -u)"
          
          # Build arguments
          ARGS="rss fetch"
          if [[ "${DRY_RUN}" == "true" ]]; then ARGS="$ARGS --dry-run"; fi
          
          echo "Running: zotero-mcp $ARGS"
          uv run zotero-mcp $ARGS

      - name: Upload RSS Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-logs-${{ github.run_number }}
          path: *.log
          retention-days: 7

  # Job 2: Gmail Processing
  gmail-process:
    if: always() && (github.event_name == 'schedule' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.job == 'all' || inputs.job == 'gmail-only')))
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        run: uv sync --locked

      - name: Process Gmail
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          # Use RSS_PROMPT for Gmail filtering too (shared logic)
          RSS_PROMPT: ${{ secrets.RSS_PROMPT }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
          # Optional custom filters from secrets
          GMAIL_SENDER_FILTER: ${{ secrets.GMAIL_SENDER_FILTER }}
          GMAIL_SUBJECT_FILTER: ${{ secrets.GMAIL_SUBJECT_FILTER }}
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "=== Gmail Processing ==="
          echo "Time: $(date -u)"
          
          # Build arguments
          # Default to empty query which means process all unread/inbox emails
          ARGS="gmail process"
          
          # Add filters if provided
          if [[ -n "${GMAIL_SENDER_FILTER}" ]]; then ARGS="$ARGS --sender '${GMAIL_SENDER_FILTER}'"; fi
          if [[ -n "${GMAIL_SUBJECT_FILTER}" ]]; then ARGS="$ARGS --subject '${GMAIL_SUBJECT_FILTER}'"; fi
          
          # If no filters, use default query to find all emails
          if [[ -z "${GMAIL_SENDER_FILTER}" && -z "${GMAIL_SUBJECT_FILTER}" ]]; then
             # Default query: in inbox
             ARGS="$ARGS --query 'in:inbox'"
          fi
          
          if [[ "${DRY_RUN}" == "true" ]]; then ARGS="$ARGS --dry-run"; fi
          
          echo "Running: zotero-mcp $ARGS"
          uv run zotero-mcp $ARGS

      - name: Upload Gmail Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gmail-logs-${{ github.run_number }}
          path: *.log
          retention-days: 7

  # Job 3: Notification (runs if any job fails)
  notify-failure:
    needs: [rss-process, gmail-process]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Daily Research Workflow Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\nPlease check logs.`,
              labels: ['automated', 'failure']
            });
