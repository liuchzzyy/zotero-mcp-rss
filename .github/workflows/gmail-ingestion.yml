name: Gmail Ingestion

on:
  schedule:
    # Run daily at 00:00 Beijing Time (16:00 UTC previous day)
    - cron: '0 16 * * *'
    
  workflow_dispatch:
    inputs:
      collection_name:
        description: 'Target Zotero collection name'
        required: false
        default: '00_INBOXS'
      sender_filter:
        description: 'Filter by sender email address'
        required: false
        default: ''
      subject_filter:
        description: 'Filter by subject (partial match)'
        required: false
        default: ''
      max_emails:
        description: 'Maximum emails to process'
        required: false
        default: 50
      dry_run:
        description: 'Preview mode - do not import or delete emails'
        required: false
        default: false

env:
  ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
  ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
  GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
  ZOTERO_INBOX_COLLECTION: ${{ github.event.inputs.collection_name || '00_INBOXS' }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install feedparser google-api-python-client
          
      - name: Run Gmail ingestion
        run: |
          python -c "
          import asyncio
          import json
          import os
          
          from zotero_mcp.services.ingestion import IngestionService
          from zotero_mcp.utils.config import get_ingestion_config
          
          async def main():
              service = IngestionService()
              config = get_ingestion_config()
              
              collection = '${{ github.event.inputs.collection_name }}'
              dry_run = '${{ github.event.inputs.dry_run }}' == 'true'
              
              print(f'starting Gmail ingestion...')
              print(f'Collection: {collection}')
              print(f'Sender filter: ${{ github.event.inputs.sender_filter }}')
              print(f'Subject filter: ${{ github.event.inputs.subject_filter }}')
              print(f'Max emails: ${{ github.event.inputs.max_emails }}')
              print(f'Dry run: {dry_run}')
              
              if dry_run:
                  print('DRY RUN MODE - No actual imports')
                  return
              
              result = await service.process_ingestion('gmail')
              print(f'Results: {result}')
          
          asyncio.run(main())
          "
