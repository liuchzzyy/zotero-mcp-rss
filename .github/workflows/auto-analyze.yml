name: Automated Zotero Analysis and Organization

# Schedule: 
#   - 6:00 AM Beijing Time (22:00 UTC previous day) - Analyze new items
#   - 8:00 PM Beijing Time (12:00 UTC) - Organize existing items
on:
  schedule:
    # 6:00 AM Beijing Time (22:00 UTC) - Process new items
    - cron: '0 22 * * *'
    # 8:00 PM Beijing Time (12:00 UTC) - Process existing items  
    - cron: '0 12 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      max_items:
        description: 'Maximum items to process (leave empty for all)'
        required: false
        type: string
      job:
        description: 'Job to run (analyze-new, organize-existing, or both)'
        required: false
        type: choice
        options:
          - both
          - analyze-new
          - organize-existing
        default: both

jobs:
  # Job 1: Analyze new items in staging collection and move to processing
  analyze-new-items:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.job == 'both' || inputs.job == 'analyze-new') || (github.event_name == 'schedule' && github.event.schedule == '0 22 * * *')
    
    environment: production
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Analyze New Items
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
        run: |
          echo "Starting new item analysis and organization..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo ""
          
          uv run python scripts/analyze_new_items.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: new-items-analysis-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ New Items Analysis Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure', 'analyze-new']
            });

  # Job 2: Re-analyze existing items and add tags
  organize-existing-items:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.job == 'both' || inputs.job == 'organize-existing') || (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *')
    
    environment: production
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Organize Existing Items
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
        run: |
          echo "Starting existing item re-analysis and organization..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo ""
          
          uv run python scripts/organize_existing_items.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: organize-existing-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Existing Items Organization Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure', 'organize-existing']
            });

  # Legacy job for backward compatibility (can be removed later)
  analyze-zotero:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.job == ''
    
    environment: production
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Run Automated Analysis
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
        run: |
          echo "Starting automated Zotero analysis..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo ""
          
          uv run python scripts/auto_analyze.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Automated Zotero Analysis Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure']
            });
