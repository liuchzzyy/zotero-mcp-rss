name: Automated RSS + Zotero

# Schedule: 
#   - 5:00 AM Beijing Time (21:00 UTC previous day) - Fetch RSS feeds
#   - 6:00 AM Beijing Time (22:00 UTC previous day) - Analyze new items
#   - 8:00 PM Beijing Time (12:00 UTC) - Organize existing items
on:
  schedule:
    # 5:00 AM Beijing Time (21:00 UTC previous day) - Fetch RSS feeds
    - cron: '0 21 * * *'
    # 6:00 AM Beijing Time (22:00 UTC previous day) - Process new items
    - cron: '0 22 * * *'
    # 8:00 PM Beijing Time (12:00 UTC) - Process existing items  
    - cron: '0 12 * * *'
  
  # Manual triggering with configurable options
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run'
        required: true
        type: choice
        options:
          - fetch-rss
          - analyze-new
          - organize-existing
          - all
        default: fetch-rss
      max_items:
        description: 'Max items to process (empty = all)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Preview only, no actual changes'
        required: false
        type: boolean
        default: false
      debug:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Fetch RSS feeds and import to staging collection
  fetch-rss:
    if: always() && (github.event_name == 'workflow_dispatch' && (inputs.job == 'all' || inputs.job == 'fetch-rss') || (github.event_name == 'schedule' && github.event.schedule == '0 21 * * *'))
    runs-on: ubuntu-latest
    
    environment: production
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Cache RSS Keywords
        uses: actions/cache@v4
        with:
          path: RSS/keywords_cache.json
          key: rss-keywords-${{ hashFiles('RSS/prompt.txt') }}
          restore-keys: |
            rss-keywords-
      
      - name: Fetch RSS Feeds
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          RSS_PROMPT: ${{ secrets.RSS_PROMPT }}
          ZOTERO_LOCAL: "false"
          # Library type defaults to user if not specified, but good to be explicit
          ZOTERO_LIBRARY_TYPE: "user"
          MAX_ITEMS: ${{ inputs.max_items }}
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "=== RSS Feed Fetch ==="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "Max Items: ${MAX_ITEMS:-all}"
          echo "Dry Run: ${DRY_RUN:-false}"
          echo "Debug: ${DEBUG:-false}"
          echo ""
          
          uv run python src/scripts/fetch_rss.py
      
      - name: Upload RSS Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-fetch-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        continue-on-error: true  # Don't fail workflow if Issues are disabled
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ RSS Feed Fetch Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure', 'rss-fetch']
            });

  # Job 2: Analyze new items in staging collection and move to processing
  analyze-new-items:
    needs: [fetch-rss]  # Run after RSS fetch if scheduled
    if: always() && (github.event_name == 'workflow_dispatch' && (inputs.job == 'all' || inputs.job == 'analyze-new') || (github.event_name == 'schedule' && github.event.schedule == '0 22 * * *'))
    runs-on: ubuntu-latest
    
    environment: production
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Analyze New Items
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          # Explicitly set library type
          ZOTERO_LIBRARY_TYPE: "user"
          MAX_ITEMS: ${{ inputs.max_items }}
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "=== New Item Analysis ==="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "Max Items: ${MAX_ITEMS:-all}"
          echo "Dry Run: ${DRY_RUN:-false}"
          echo "Debug: ${DEBUG:-false}"
          echo ""
          
          uv run python src/scripts/analyze_new_items.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: new-items-analysis-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        continue-on-error: true  # Don't fail workflow if Issues are disabled
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ New Items Analysis Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure', 'analyze-new']
            });

  # Job 2: Re-analyze existing items and add tags
  organize-existing-items:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.job == 'all' || inputs.job == 'organize-existing') || (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *')
    
    environment: production
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Organize Existing Items
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          # Explicitly set library type
          ZOTERO_LIBRARY_TYPE: "user"
          MAX_ITEMS: ${{ inputs.max_items }}
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "=== Organize Existing Items ==="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo "Max Items: ${MAX_ITEMS:-all}"
          echo "Dry Run: ${DRY_RUN:-false}"
          echo "Debug: ${DEBUG:-false}"
          echo ""
          
          uv run python src/scripts/organize_existing_items.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: organize-existing-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        continue-on-error: true  # Don't fail workflow if Issues are disabled
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Existing Items Organization Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure', 'organize-existing']
            });
