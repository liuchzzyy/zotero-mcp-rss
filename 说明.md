# Zotero MCP é¡¹ç›®è¯¦ç»†è¯´æ˜æ–‡æ¡£

## ğŸ“‘ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#2-æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#3-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [å·¥ä½œæµç¨‹](#4-å·¥ä½œæµç¨‹)
5. [æ•°æ®æµè½¬](#5-æ•°æ®æµè½¬)
6. [å…³é”®æŠ€æœ¯å®ç°](#6-å…³é”®æŠ€æœ¯å®ç°)
7. [æµ‹è¯•æŒ‡å—](#7-æµ‹è¯•æŒ‡å—)
8. [å¸¸è§é—®é¢˜æ’æŸ¥](#8-å¸¸è§é—®é¢˜æ’æŸ¥)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**Zotero MCP** æ˜¯ä¸€ä¸ªåŸºäº Model Context Protocol (MCP) åè®®çš„æœåŠ¡å™¨ï¼Œç”¨äºè¿æ¥ Zotero ç ”ç©¶æ–‡çŒ®åº“ä¸ AI åŠ©æ‰‹ï¼ˆå¦‚ ChatGPTã€OpenAI ç­‰ï¼‰ã€‚å®ƒå…è®¸ AI åŠ©æ‰‹é€šè¿‡æ ‡å‡†åŒ–çš„å·¥å…·æ¥å£è®¿é—®ã€æœç´¢å’Œç®¡ç† Zotero åº“ä¸­çš„æ–‡çŒ®èµ„æºã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

1. **æ–‡çŒ®æœç´¢**
   - å…³é”®è¯æœç´¢ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€å¹´ä»½ï¼‰
   - å…¨æ–‡æœç´¢
   - æ ‡ç­¾è¿‡æ»¤æœç´¢
   - é«˜çº§ç»„åˆæœç´¢
   - **AI è¯­ä¹‰æœç´¢**ï¼ˆåŸºäºå‘é‡ç›¸ä¼¼åº¦ï¼‰

2. **å†…å®¹è®¿é—®**
   - è·å–æ–‡çŒ®å…ƒæ•°æ®ï¼ˆæ”¯æŒ BibTeXã€JSONã€Markdown æ ¼å¼ï¼‰
   - æå– PDF å…¨æ–‡å†…å®¹
   - è®¿é—®é™„ä»¶ã€ç¬”è®°ã€å­æ¡ç›®
   - è·å–æ–‡çŒ® Bundleï¼ˆå®Œæ•´æ•°æ®åŒ…ï¼‰

3. **æ³¨é‡Šç®¡ç†**
   - æå– PDF æ³¨é‡Šï¼ˆé«˜äº®ã€è¯„è®ºã€æ‰¹æ³¨ï¼‰
   - æœç´¢ç¬”è®°å’Œæ³¨é‡Š
   - åˆ›å»ºæ–°ç¬”è®°

4. **æ‰¹é‡åˆ†æå·¥ä½œæµ** (NEW)
   - AI é©±åŠ¨çš„æ‰¹é‡ PDF åˆ†æ
   - æ–­ç‚¹ç»­ä¼ æ”¯æŒ
   - ç”Ÿæˆç»“æ„åŒ–å­¦æœ¯ç¬”è®°
   - æ”¯æŒ DeepSeekã€OpenAIã€Gemini

5. **æ•°æ®åº“ç®¡ç†**
   - è¯­ä¹‰æœç´¢æ•°æ®åº“æ›´æ–°
   - æ•°æ®åº“çŠ¶æ€æŸ¥è¯¢
   - è‡ªåŠ¨/æ‰‹åŠ¨åŒæ­¥

### 1.3 æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.10+
- **æ¡†æ¶**: FastMCP (Model Context Protocol å®ç°)
- **æ•°æ®éªŒè¯**: Pydantic (ç±»å‹å®‰å…¨çš„æ•°æ®æ¨¡å‹)
- **å‘é‡æ•°æ®åº“**: ChromaDB (è¯­ä¹‰æœç´¢)
- **åµŒå…¥æ¨¡å‹**: Sentence Transformers / OpenAI / Gemini
- **Zotero æ¥å£**: 
  - Web API (pyzotero)
  - Local API (ç›´æ¥è®¿é—® SQLite)
  - Better BibTeX (JSON-RPC)

---

## 2. æ•´ä½“æ¶æ„

### 2.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AI å®¢æˆ·ç«¯å±‚                              â”‚
â”‚   (Opencode CLI, Cherry Studio, Cursor, ChatGPT, etc.)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ MCP Protocol (JSON-RPC over stdio/HTTP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MCP Server å±‚                              â”‚
â”‚  (src/zotero_mcp/server.py + tools/)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tools Layer (å·¥å…·å±‚)                                â”‚   â”‚
â”‚  â”‚  - search.py: æœç´¢å·¥å…·                               â”‚   â”‚
â”‚  â”‚  - items.py: æ¡ç›®æ“ä½œå·¥å…·                            â”‚   â”‚
â”‚  â”‚  - annotations.py: æ³¨é‡Šå·¥å…·                          â”‚   â”‚
â”‚  â”‚  - database.py: æ•°æ®åº“å·¥å…·                           â”‚   â”‚
â”‚  â”‚  - batch.py: æ‰¹å¤„ç†å·¥å…·                              â”‚   â”‚
â”‚  â”‚  - workflow.py: å·¥ä½œæµå·¥å…·                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Services å±‚ (ä¸šåŠ¡é€»è¾‘)                     â”‚
â”‚  (src/zotero_mcp/services/)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DataAccessService (ç»Ÿä¸€æ•°æ®è®¿é—®æœåŠ¡)                  â”‚ â”‚
â”‚  â”‚  - è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ•°æ®æº (Local DB / Web API / BBT)     â”‚ â”‚
â”‚  â”‚  - æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ZoteroSemanticSearch (è¯­ä¹‰æœç´¢æœåŠ¡)                   â”‚ â”‚
â”‚  â”‚  - å‘é‡æ•°æ®åº“ç®¡ç†                                    â”‚ â”‚
â”‚  â”‚  - ç›¸ä¼¼åº¦æœç´¢                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ WorkflowService (æ‰¹é‡åˆ†æå·¥ä½œæµ)                      â”‚ â”‚
â”‚  â”‚  - PDF æ‰¹é‡åˆ†æ                                      â”‚ â”‚
â”‚  â”‚  - æ–­ç‚¹ç»­ä¼ ç®¡ç†                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Clients å±‚ (æ•°æ®é€‚é…å™¨)                   â”‚
â”‚  (src/zotero_mcp/clients/)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ZoteroAPIClientâ”‚  â”‚LocalDBClient â”‚  â”‚BetterBibTeXClientâ”‚ â”‚
â”‚  â”‚(Web API)     â”‚  â”‚(SQLiteç›´æ¥è®¿é—®)â”‚ â”‚(JSON-RPC)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ChromaClient  â”‚  â”‚LLMClient     â”‚                       â”‚
â”‚  â”‚(å‘é‡æ•°æ®åº“)   â”‚  â”‚(AI åˆ†æ)     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®æºå±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Zotero Web APIâ”‚  â”‚zotero.sqlite â”‚  â”‚Better BibTeX    â”‚  â”‚
â”‚  â”‚(è¿œç¨‹)        â”‚  â”‚(æœ¬åœ°æ•°æ®åº“)   â”‚  â”‚(æœ¬åœ°æ’ä»¶)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ChromaDB      â”‚  â”‚DeepSeek/     â”‚                       â”‚
â”‚  â”‚(å‘é‡åº“)      â”‚  â”‚OpenAI/Gemini â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
zotero-mcp/
â”œâ”€â”€ src/zotero_mcp/
â”‚   â”œâ”€â”€ server.py              # MCP æœåŠ¡å™¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ cli.py                 # å‘½ä»¤è¡Œç•Œé¢
â”‚   â”œâ”€â”€ __init__.py            # åŒ…åˆå§‹åŒ–ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                 # MCP å·¥å…·å®šä¹‰å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py        # æ³¨å†Œæ‰€æœ‰å·¥å…·
â”‚   â”‚   â”œâ”€â”€ search.py          # æœç´¢å·¥å…· (5ä¸ª)
â”‚   â”‚   â”œâ”€â”€ items.py           # æ¡ç›®å·¥å…· (4ä¸ª)
â”‚   â”‚   â”œâ”€â”€ annotations.py     # æ³¨é‡Šå·¥å…· (4ä¸ª)
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“å·¥å…· (2ä¸ª)
â”‚   â”‚   â”œâ”€â”€ batch.py           # æ‰¹å¤„ç†å·¥å…· (2ä¸ª)
â”‚   â”‚   â””â”€â”€ workflow.py        # å·¥ä½œæµå·¥å…· (5ä¸ª)
â”‚   â”‚
â”‚   â”œâ”€â”€ services/              # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py        # æœåŠ¡å·¥å‚å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ data_access.py     # ç»Ÿä¸€æ•°æ®è®¿é—®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ semantic.py        # è¯­ä¹‰æœç´¢æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ workflow.py        # æ‰¹é‡åˆ†æå·¥ä½œæµæœåŠ¡
â”‚   â”‚   â””â”€â”€ checkpoint.py      # å·¥ä½œæµæ–­ç‚¹ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ clients/               # æ•°æ®é€‚é…å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ zotero_client.py   # Zotero Web/Local API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ local_db.py        # ç›´æ¥ SQLite è®¿é—®
â”‚   â”‚   â”œâ”€â”€ better_bibtex.py   # Better BibTeX æ’ä»¶æ¥å£
â”‚   â”‚   â”œâ”€â”€ chroma.py          # ChromaDB å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ llm.py             # LLM å®¢æˆ·ç«¯ (DeepSeek/OpenAI/Gemini)
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                # Pydantic æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ common.py          # é€šç”¨æ¨¡å‹ï¼ˆBaseResponse, SearchResponse ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ search.py          # æœç´¢ç›¸å…³è¾“å…¥/è¾“å‡ºæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ items.py           # æ¡ç›®ç›¸å…³æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ annotations.py     # æ³¨é‡Šç›¸å…³æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“ç›¸å…³æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ batch.py           # æ‰¹å¤„ç†ç›¸å…³æ¨¡å‹
â”‚   â”‚   â””â”€â”€ workflow.py        # å·¥ä½œæµç›¸å…³æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ formatters/            # å“åº”æ ¼å¼åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ markdown.py        # Markdown æ ¼å¼åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ json.py            # JSON æ ¼å¼åŒ–å™¨
â”‚   â”‚   â””â”€â”€ bibtex.py          # BibTeX æ ¼å¼åŒ–å™¨
â”‚   â”‚
â”‚   â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ errors.py          # ç»Ÿä¸€é”™è¯¯å¤„ç†
â”‚       â”œâ”€â”€ helpers.py         # è¾…åŠ©å‡½æ•°
â”‚       â”œâ”€â”€ setup.py           # åˆå§‹åŒ–è®¾ç½®
â”‚       â”œâ”€â”€ updater.py         # ç‰ˆæœ¬æ›´æ–°
â”‚       â”œâ”€â”€ cache.py           # ç¼“å­˜è£…é¥°å™¨
â”‚       â”œâ”€â”€ metrics.py         # æ€§èƒ½ç›‘æ§
â”‚       â”œâ”€â”€ markdown_html.py   # Markdown/HTML è½¬æ¢
â”‚       â””â”€â”€ response_converter.py  # å“åº”è½¬æ¢å™¨
â”‚
â”œâ”€â”€ pyproject.toml             # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ uv.lock                    # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ README.md                  # ç”¨æˆ·æ–‡æ¡£
â”œâ”€â”€ AGENTS.md                  # å¼€å‘è€…æŒ‡å—
â”œâ”€â”€ Template.yaml              # æ¨¡æ¿é…ç½®
â””â”€â”€ tests/                     # æµ‹è¯•æ–‡ä»¶
```

---

## 3. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 3.1 MCP Server å±‚

#### server.py - ä¸»å…¥å£

```python
# src/zotero_mcp/server.py

from fastmcp import FastMCP
from zotero_mcp.tools import register_all_tools
from zotero_mcp.utils.config import load_config

# åˆå§‹åŒ– FastMCP æœåŠ¡å™¨
mcp = FastMCP(name="Zotero")

# åŠ è½½é…ç½®
load_config()

# æ³¨å†Œæ‰€æœ‰å·¥å…·
register_all_tools(mcp)

def run():
    """è¿è¡Œ MCP æœåŠ¡å™¨"""
    mcp.run()
```

**å·¥ä½œåŸç†**:
1. åˆ›å»º FastMCP å®ä¾‹ï¼ˆMCP åè®®çš„ Python å®ç°ï¼‰
2. åŠ è½½ç¯å¢ƒé…ç½®ï¼ˆä»ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶åŠ è½½ï¼‰
3. æ³¨å†Œæ‰€æœ‰å·¥å…·ï¼ˆé€šè¿‡ `@mcp.tool` è£…é¥°å™¨ï¼‰
4. å¯åŠ¨æœåŠ¡å™¨ï¼Œç›‘å¬ stdin/stdoutï¼ˆstdio æ¨¡å¼ï¼‰æˆ– HTTP

#### cli.py - å‘½ä»¤è¡Œç•Œé¢

æä¾›å¤šç§å­å‘½ä»¤ï¼š
- `serve`: å¯åŠ¨ MCP æœåŠ¡å™¨
- `setup`: é…ç½®å‘å¯¼ï¼ˆZotero è¿æ¥ã€è¯­ä¹‰æœç´¢ç­‰ï¼‰
- `update`: æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- `update-db`: æ›´æ–°è¯­ä¹‰æœç´¢æ•°æ®åº“
- `db-status`: æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
- `version`: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯

### 3.2 Tools å±‚ï¼ˆå·¥å…·å®šä¹‰ï¼‰

æ¯ä¸ªå·¥å…·æ–‡ä»¶æ³¨å†Œä¸€ç»„ç›¸å…³çš„ MCP å·¥å…·ã€‚

#### å·¥å…·æ³¨å†Œæ¨¡å¼

```python
# ç¤ºä¾‹: search.py

from fastmcp import FastMCP, Context
from mcp.types import ToolAnnotations

def register_search_tools(mcp: FastMCP):
    @mcp.tool(
        name="zotero_search",
        annotations=ToolAnnotations(
            title="Search Zotero Library",
            readOnlyHint=True,        # åªè¯»å·¥å…·
            destructiveHint=False,    # éç ´åæ€§
            idempotentHint=True,      # å¹‚ç­‰ï¼ˆé‡å¤è°ƒç”¨ç»“æœç›¸åŒï¼‰
        ),
    )
    @cached_tool(ttl_seconds=300)     # ç¼“å­˜ 5 åˆ†é’Ÿ
    async def zotero_search(params: SearchItemsInput, ctx: Context) -> SearchResponse:
        """
        æœç´¢å·¥å…·å®ç°
        
        Args:
            params: Pydantic éªŒè¯çš„è¾“å…¥å‚æ•°
            ctx: MCP ä¸Šä¸‹æ–‡ï¼ˆç”¨äºè¿›åº¦æŠ¥å‘Šã€æ—¥å¿—ç­‰ï¼‰
        
        Returns:
            SearchResponse: ç»“æ„åŒ–å“åº”æ¨¡å‹
        """
        try:
            # 1. è·å–æ•°æ®æœåŠ¡å®ä¾‹
            service = get_data_service()
            
            # 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘
            results = await service.search_items(
                query=params.query,
                limit=params.limit,
                offset=params.offset,
                qmode=params.qmode.value,
            )
            
            # 3. è½¬æ¢ä¸ºå“åº”æ¨¡å‹
            items = [
                SearchResultItem(
                    key=r.key,
                    title=r.title,
                    authors=r.authors,
                    # ...
                )
                for r in results
            ]
            
            # 4. è¿”å›ç»“æ„åŒ–å“åº”
            return SearchResponse(
                success=True,
                query=params.query,
                count=len(items),
                items=items,
                has_more=len(items) >= params.limit,
            )
            
        except Exception as e:
            # ç»Ÿä¸€é”™è¯¯å¤„ç†
            return SearchResponse(
                success=False,
                error=str(e),
                query=params.query,
                count=0,
                items=[],
            )
```

#### æ‰€æœ‰å·¥å…·åˆ—è¡¨

| æ–‡ä»¶ | å·¥å…·æ•°é‡ | å·¥å…·åç§° |
|------|---------|---------|
| `search.py` | 5 | `zotero_search`, `zotero_search_by_tag`, `zotero_advanced_search`, `zotero_semantic_search`, `zotero_get_recent` |
| `items.py` | 4 | `zotero_get_metadata`, `zotero_get_fulltext`, `zotero_get_children`, `zotero_get_bundle` |
| `annotations.py` | 4 | `zotero_get_annotations`, `zotero_get_notes`, `zotero_search_notes`, `zotero_create_note` |
| `database.py` | 2 | `zotero_update_database`, `zotero_database_status` |
| `batch.py` | 2 | `zotero_get_collections`, `zotero_get_collection_items` |
| `workflow.py` | 5 | `zotero_prepare_analysis`, `zotero_batch_analyze_pdfs`, `zotero_resume_workflow`, `zotero_list_workflows`, `zotero_find_collection` |

**æ€»è®¡**: 22 ä¸ª MCP å·¥å…·

### 3.3 Services å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

#### DataAccessService - ç»Ÿä¸€æ•°æ®è®¿é—®æœåŠ¡

**èŒè´£**: è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ•°æ®æºï¼Œæä¾›ç»Ÿä¸€æŸ¥è¯¢æ¥å£

```python
class DataAccessService:
    """ç»Ÿä¸€æ•°æ®è®¿é—®æœåŠ¡"""
    
    def __init__(self):
        self._api_client = None       # Zotero Web API
        self._local_client = None     # Local SQLite
        self._bibtex_client = None    # Better BibTeX
    
    async def search_items(self, query: str, limit: int, offset: int, qmode: str):
        """
        æœç´¢æ¡ç›®ï¼ˆè‡ªåŠ¨é€‰æ‹©æ•°æ®æºï¼‰
        
        ç­–ç•¥:
        1. å¦‚æœæ˜¯æœ¬åœ°æ¨¡å¼ + qmode='everything' â†’ ä½¿ç”¨ LocalDBClientï¼ˆæ›´å¿«ï¼‰
        2. å¦åˆ™ â†’ ä½¿ç”¨ Zotero Web API
        """
        if self.local_client and qmode == "everything":
            try:
                return self.local_client.search_items(query, limit=limit+offset)
            except Exception:
                # å¤±è´¥åˆ™é™çº§åˆ° API
                pass
        
        # ä½¿ç”¨ Web API
        return await self.api_client.search_items(query, qmode, limit, offset)
    
    async def get_item_metadata(self, item_key: str):
        """
        è·å–æ¡ç›®å…ƒæ•°æ®
        
        ç­–ç•¥:
        1. ä¼˜å…ˆä½¿ç”¨ LocalDBClientï¼ˆå¦‚æœå¯ç”¨ï¼‰
        2. é™çº§åˆ° API
        """
        if self.local_client:
            return self.local_client.get_item(item_key)
        return await self.api_client.get_item(item_key)
    
    async def get_annotations(self, item_key: str):
        """
        è·å–æ³¨é‡Š
        
        ç­–ç•¥:
        1. ä¼˜å…ˆä½¿ç”¨ Better BibTeXï¼ˆæ”¯æŒ PDF ç›´æ¥æå–ï¼‰
        2. é™çº§åˆ° API æˆ– Local DB
        """
        if self.bibtex_client:
            return self.bibtex_client.get_annotations(item_key)
        # é™çº§ç­–ç•¥...
```

**æ•°æ®æºé€‰æ‹©é€»è¾‘**:

| æ“ä½œ | ä¼˜å…ˆçº§ 1 | ä¼˜å…ˆçº§ 2 | ä¼˜å…ˆçº§ 3 |
|------|---------|---------|---------|
| æœç´¢æ¡ç›® | Local DB (æœ¬åœ°æ¨¡å¼) | Web API | - |
| è·å–å…ƒæ•°æ® | Local DB | Web API | - |
| è·å–å…¨æ–‡ | Local DB (ç´¢å¼•è¿‡) | Web API | - |
| è·å–æ³¨é‡Š | Better BibTeX | Web API | Local DB |
| åˆ›å»ºç¬”è®° | Web API | - | - |

#### ZoteroSemanticSearch - è¯­ä¹‰æœç´¢æœåŠ¡

**èŒè´£**: ç®¡ç†å‘é‡æ•°æ®åº“ï¼Œæ‰§è¡Œè¯­ä¹‰æœç´¢

```python
class ZoteroSemanticSearch:
    """è¯­ä¹‰æœç´¢æœåŠ¡"""
    
    def __init__(self, config_path: str | None = None):
        # åˆå§‹åŒ– ChromaDB å®¢æˆ·ç«¯
        self.chroma_client = ChromaClient(
            collection_name="zotero_items",
            embedding_function=self._get_embedding_function()
        )
        
        # Zotero æ•°æ®è®¿é—®
        self.zotero_client = get_zotero_client()
    
    def update_database(
        self, 
        force_full_rebuild: bool = False,
        limit: int | None = None,
        extract_fulltext: bool = False
    ):
        """
        æ›´æ–°å‘é‡æ•°æ®åº“
        
        æµç¨‹:
        1. è·å–æ‰€æœ‰ Zotero æ¡ç›®
        2. æå–å…ƒæ•°æ® + å…¨æ–‡ï¼ˆå¯é€‰ï¼‰
        3. ç”ŸæˆåµŒå…¥å‘é‡
        4. å­˜å…¥ ChromaDB
        """
        # è·å–æ¡ç›®
        items = self.zotero_client.get_all_items(limit=limit)
        
        # å‡†å¤‡æ–‡æ¡£
        documents = []
        metadatas = []
        ids = []
        
        for item in items:
            # æå–æ–‡æœ¬
            text = self._extract_item_text(item, extract_fulltext)
            
            documents.append(text)
            metadatas.append({
                'item_key': item['key'],
                'title': item['data']['title'],
                'creators': format_creators(item['data'].get('creators', [])),
                'year': item['data'].get('date', '')[:4],
            })
            ids.append(item['key'])
        
        # æ‰¹é‡æ’å…¥å‘é‡æ•°æ®åº“
        self.chroma_client.add_documents(
            documents=documents,
            metadatas=metadatas,
            ids=ids
        )
    
    async def search(self, query: str, limit: int = 10):
        """
        æ‰§è¡Œè¯­ä¹‰æœç´¢
        
        æµç¨‹:
        1. å°†æŸ¥è¯¢æ–‡æœ¬è½¬ä¸ºå‘é‡
        2. åœ¨ ChromaDB ä¸­æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„æ–‡æ¡£
        3. è¿”å›ç»“æœ + ç›¸ä¼¼åº¦åˆ†æ•°
        """
        results = self.chroma_client.query(
            query_texts=[query],
            n_results=limit
        )
        
        return results
```

#### WorkflowService - æ‰¹é‡åˆ†æå·¥ä½œæµ

**èŒè´£**: ç®¡ç†æ‰¹é‡ PDF åˆ†ææµç¨‹ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 

```python
class WorkflowService:
    """æ‰¹é‡åˆ†æå·¥ä½œæµæœåŠ¡"""
    
    async def batch_analyze(
        self,
        source: str,              # "collection" or "recent"
        collection_key: str | None,
        limit: int = 20,
        resume_workflow_id: str | None = None,
        llm_provider: str = "auto",
        dry_run: bool = False,
        progress_callback: Callable | None = None
    ):
        """
        æ‰¹é‡åˆ†æ PDF
        
        æµç¨‹:
        1. åŠ è½½æˆ–åˆ›å»ºå·¥ä½œæµçŠ¶æ€
        2. è·å–å¾…å¤„ç†æ¡ç›®åˆ—è¡¨
        3. å¯¹æ¯ä¸ªæ¡ç›®:
           a. è·å–å…ƒæ•°æ®ã€å…¨æ–‡ã€æ³¨é‡Š
           b. è°ƒç”¨ LLM åˆ†æ
           c. è½¬æ¢ Markdown â†’ HTML
           d. åˆ›å»ºç¬”è®°ï¼ˆå¦‚æœä¸æ˜¯ dry_runï¼‰
           e. æ›´æ–°æ£€æŸ¥ç‚¹
        4. è¿”å›åˆ†æç»“æœ
        """
        # 1. å·¥ä½œæµçŠ¶æ€ç®¡ç†
        if resume_workflow_id:
            workflow_state = self.checkpoint_manager.load_state(resume_workflow_id)
        else:
            workflow_state = self.checkpoint_manager.create_state(...)
        
        # 2. è·å–æ¡ç›®
        items = await self._get_items_for_analysis(source, collection_key, limit)
        
        # è¿‡æ»¤å·²å¤„ç†çš„
        remaining = workflow_state.get_remaining_items(items)
        
        # 3. åˆå§‹åŒ– LLM
        llm_client = get_llm_client(llm_provider)
        
        # 4. é€ä¸ªåˆ†æ
        for i, item in enumerate(remaining):
            try:
                # æŠ¥å‘Šè¿›åº¦
                if progress_callback:
                    await progress_callback(i+1, len(remaining), f"åˆ†æ {item['title']}")
                
                # æ‰§è¡Œåˆ†æ
                result = await self._analyze_single_item(
                    item_key=item['key'],
                    llm_client=llm_client,
                    dry_run=dry_run
                )
                
                # æ›´æ–°çŠ¶æ€
                workflow_state.mark_processed(item['key'], result)
                
            except Exception as e:
                workflow_state.mark_failed(item['key'], str(e))
            
            # ä¿å­˜æ£€æŸ¥ç‚¹
            self.checkpoint_manager.save_state(workflow_state)
        
        return BatchAnalyzeResponse(
            success=True,
            workflow_id=workflow_state.workflow_id,
            total_items=len(items),
            processed=workflow_state.processed_count,
            failed=workflow_state.failed_count,
        )
```

### 3.4 Clients å±‚ï¼ˆæ•°æ®é€‚é…å™¨ï¼‰

#### ZoteroAPIClient - Web/Local API å®¢æˆ·ç«¯

```python
class ZoteroAPIClient:
    """Zotero API å®¢æˆ·ç«¯ï¼ˆWeb + Localï¼‰"""
    
    def __init__(self, use_local: bool = False):
        self.use_local = use_local
        
        if use_local:
            # æœ¬åœ° APIï¼ˆé€šè¿‡ HTTP è¿æ¥åˆ° Zotero åº”ç”¨ï¼‰
            self._init_local_api()
        else:
            # Web APIï¼ˆéœ€è¦ API Keyï¼‰
            self._init_web_api()
    
    async def search_items(self, query: str, qmode: str, limit: int, start: int):
        """æœç´¢æ¡ç›®"""
        if self.use_local:
            # æœ¬åœ° API æœç´¢
            return await self._local_search(query, qmode, limit, start)
        else:
            # Web API æœç´¢
            return self.zot.items(q=query, qmode=qmode, limit=limit, start=start)
    
    async def get_item(self, item_key: str):
        """è·å–å•ä¸ªæ¡ç›®"""
        return self.zot.item(item_key)
```

#### LocalDatabaseClient - ç›´æ¥ SQLite è®¿é—®

```python
class LocalDatabaseClient:
    """æœ¬åœ°æ•°æ®åº“å®¢æˆ·ç«¯ï¼ˆç›´æ¥è¯»å– zotero.sqliteï¼‰"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
    
    def search_items(self, query: str, limit: int = 25):
        """
        åœ¨æœ¬åœ°æ•°æ®åº“ä¸­æœç´¢
        
        æŸ¥è¯¢ SQL:
        SELECT * FROM items
        JOIN itemData ON items.itemID = itemData.itemID
        WHERE title LIKE ? OR abstract LIKE ?
        LIMIT ?
        """
        cursor = self.conn.execute(
            """
            SELECT i.key, i.itemID, ...
            FROM items i
            LEFT JOIN itemData id ON i.itemID = id.itemID
            WHERE ...
            LIMIT ?
            """,
            (f"%{query}%", limit)
        )
        
        return [self._row_to_item(row) for row in cursor.fetchall()]
    
    def get_fulltext(self, item_key: str):
        """
        è·å–å…¨æ–‡å†…å®¹
        
        æŸ¥è¯¢ SQL:
        SELECT value FROM fulltextItems
        WHERE itemID = (SELECT itemID FROM items WHERE key = ?)
        """
        ...
```

#### ChromaClient - å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯

```python
class ChromaClient:
    """ChromaDB å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯"""
    
    def __init__(self, collection_name: str, embedding_function):
        self.client = chromadb.PersistentClient(
            path=str(Path.home() / ".config" / "zotero-mcp" / "chroma_db")
        )
        
        self.collection = self.client.get_or_create_collection(
            name=collection_name,
            embedding_function=embedding_function
        )
    
    def add_documents(self, documents, metadatas, ids):
        """æ‰¹é‡æ·»åŠ æ–‡æ¡£"""
        self.collection.add(
            documents=documents,
            metadatas=metadatas,
            ids=ids
        )
    
    def query(self, query_texts, n_results=10):
        """æŸ¥è¯¢ç›¸ä¼¼æ–‡æ¡£"""
        return self.collection.query(
            query_texts=query_texts,
            n_results=n_results
        )
```

### 3.5 Models å±‚ï¼ˆæ•°æ®æ¨¡å‹ï¼‰

æ‰€æœ‰è¾“å…¥/è¾“å‡ºä½¿ç”¨ Pydantic è¿›è¡Œç±»å‹éªŒè¯ï¼š

```python
# models/common.py

from pydantic import BaseModel, Field

class BaseResponse(BaseModel):
    """æ‰€æœ‰å“åº”çš„åŸºç±»"""
    success: bool = True
    error: str | None = None
    message: str | None = None

class SearchResultItem(BaseModel):
    """æœç´¢ç»“æœé¡¹"""
    key: str = Field(..., description="Zotero item key")
    title: str = Field(..., description="Item title")
    authors: str = Field(default="", description="Formatted authors")
    date: str | None = Field(None, description="Publication date")
    item_type: str = Field(..., description="Item type (journalArticle, book, etc.)")
    abstract: str | None = None
    doi: str | None = None
    tags: list[str] = Field(default_factory=list)
    similarity_score: float | None = None

class SearchResponse(BaseResponse):
    """æœç´¢å“åº”"""
    query: str
    count: int = 0
    total: int = 0
    offset: int = 0
    limit: int = 20
    has_more: bool = False
    next_offset: int | None = None
    items: list[SearchResultItem] = Field(default_factory=list)
```

---

## 4. å·¥ä½œæµç¨‹

### 4.1 å¯åŠ¨æµç¨‹

```
1. ç”¨æˆ·å¯åŠ¨ AI å®¢æˆ·ç«¯ (å¦‚ Opencode CLI)
   â†“
2. AI å®¢æˆ·ç«¯è¯»å–é…ç½® (~/.opencode/config.json æˆ– ~/.config/zotero-mcp/config.json)
   {
     "mcpServers": {
       "zotero": {
         "command": "zotero-mcp",
         "env": { "ZOTERO_LOCAL": "true" }
       }
     }
   }
   â†“
3. AI å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤: zotero-mcp serve --transport stdio
   â†“
4. Zotero MCP æœåŠ¡å™¨å¯åŠ¨
   â”œâ”€ åŠ è½½é…ç½® (load_config)
   â”œâ”€ åˆå§‹åŒ–å®¢æˆ·ç«¯ (Zotero API, Local DB, ChromaDB)
   â”œâ”€ æ³¨å†Œ 22 ä¸ª MCP å·¥å…·
   â””â”€ ç›‘å¬ stdin/stdout
   â†“
5. AI å®¢æˆ·ç«¯é€šè¿‡ MCP åè®®å‘ç°å¯ç”¨å·¥å…·
   â”œâ”€ å‘é€: tools/list è¯·æ±‚
   â””â”€ æ¥æ”¶: 22 ä¸ªå·¥å…·çš„å®šä¹‰ (åç§°ã€å‚æ•°ã€æè¿°)
   â†“
6. ç”¨æˆ·å¯ä»¥é€šè¿‡ AI åŠ©æ‰‹è°ƒç”¨ Zotero å·¥å…·
```

### 4.2 æœç´¢è¯·æ±‚æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "æœç´¢æˆ‘çš„åº“ä¸­å…³äºæœºå™¨å­¦ä¹ çš„è®ºæ–‡"
   â†“
AI åŠ©æ‰‹è§£ææ„å›¾ â†’ å†³å®šè°ƒç”¨ zotero_search å·¥å…·
   â†“
MCP è¯·æ±‚:
{
  "method": "tools/call",
  "params": {
    "name": "zotero_search",
    "arguments": {
      "query": "machine learning",
      "limit": 10,
      "qmode": "titleCreatorYear"
    }
  }
}
   â†“
Zotero MCP æœåŠ¡å™¨å¤„ç†:
   â”œâ”€ 1. éªŒè¯è¾“å…¥å‚æ•° (Pydantic: SearchItemsInput)
   â”œâ”€ 2. è°ƒç”¨ DataAccessService.search_items()
   â”‚     â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ¬åœ°æ¨¡å¼
   â”‚     â”œâ”€ é€‰æ‹©æ•°æ®æº (Local DB æˆ– Web API)
   â”‚     â””â”€ æ‰§è¡Œæœç´¢
   â”œâ”€ 3. è½¬æ¢ç»“æœä¸º SearchResultItem åˆ—è¡¨
   â””â”€ 4. æ„å»º SearchResponse è¿”å›
   â†“
MCP å“åº”:
{
  "result": {
    "success": true,
    "query": "machine learning",
    "count": 10,
    "items": [
      {
        "key": "ABC123",
        "title": "Deep Learning for Computer Vision",
        "authors": "Smith, J.; Doe, A.",
        "year": "2023",
        ...
      },
      ...
    ]
  }
}
   â†“
AI åŠ©æ‰‹å‘ˆç°ç»“æœç»™ç”¨æˆ·
```

### 4.3 è¯­ä¹‰æœç´¢æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "æ‰¾åˆ°ä¸ç¥ç»ç½‘ç»œåœ¨åŒ»ç–—è¯Šæ–­ä¸­çš„åº”ç”¨ç›¸å…³çš„è®ºæ–‡"
   â†“
AI åŠ©æ‰‹è°ƒç”¨ zotero_semantic_search
   â†“
MCP è¯·æ±‚:
{
  "method": "tools/call",
  "params": {
    "name": "zotero_semantic_search",
    "arguments": {
      "query": "neural networks in medical diagnosis",
      "limit": 10
    }
  }
}
   â†“
Zotero MCP å¤„ç†:
   â”œâ”€ 1. è°ƒç”¨ ZoteroSemanticSearch.search()
   â”‚     â”œâ”€ å°†æŸ¥è¯¢æ–‡æœ¬è½¬ä¸ºå‘é‡ (åµŒå…¥æ¨¡å‹)
   â”‚     â”‚   "neural networks..." â†’ [0.12, 0.45, -0.33, ...]
   â”‚     â”œâ”€ åœ¨ ChromaDB ä¸­æŸ¥è¯¢æœ€è¿‘é‚»
   â”‚     â”‚   SELECT * FROM embeddings
   â”‚     â”‚   ORDER BY cosine_similarity(query_vector, document_vector) DESC
   â”‚     â”‚   LIMIT 10
   â”‚     â””â”€ è¿”å›åŒ¹é…æ–‡æ¡£ + ç›¸ä¼¼åº¦åˆ†æ•°
   â”œâ”€ 2. è·å–å®Œæ•´å…ƒæ•°æ® (ä» Zotero)
   â””â”€ 3. è¿”å› SearchResponse (åŒ…å« similarity_score)
   â†“
è¿”å›ç»“æœ:
{
  "success": true,
  "items": [
    {
      "title": "Neural Networks for Medical Imaging",
      "similarity_score": 0.89,
      ...
    },
    {
      "title": "Deep Learning in Healthcare",
      "similarity_score": 0.84,
      ...
    }
  ]
}
```

### 4.4 æ‰¹é‡åˆ†æå·¥ä½œæµ

```
ç”¨æˆ·è¾“å…¥: "æ‰¹é‡åˆ†ææœ€è¿‘ 5 ç¯‡è®ºæ–‡ï¼Œä½¿ç”¨ DeepSeek"
   â†“
AI åŠ©æ‰‹è°ƒç”¨ zotero_batch_analyze_pdfs
   â†“
MCP è¯·æ±‚:
{
  "name": "zotero_batch_analyze_pdfs",
  "arguments": {
    "source": "recent",
    "limit": 5,
    "llm_provider": "deepseek"
  }
}
   â†“
WorkflowService å¤„ç†:
   â”œâ”€ 1. åˆ›å»ºå·¥ä½œæµçŠ¶æ€
   â”‚     workflow_id = "wf_20260124_123456_abc"
   â”‚     çŠ¶æ€ä¿å­˜åœ¨: ~/.config/zotero-mcp/workflows/wf_....json
   â”‚
   â”œâ”€ 2. è·å–æœ€è¿‘ 5 ç¯‡è®ºæ–‡
   â”‚     items = await data_service.get_recent_items(limit=5)
   â”‚
   â”œâ”€ 3. åˆå§‹åŒ– DeepSeek LLM å®¢æˆ·ç«¯
   â”‚     llm_client = LLMClient(provider="deepseek")
   â”‚
   â”œâ”€ 4. é€ä¸ªåˆ†æè®ºæ–‡
   â”‚     for item in items:
   â”‚       â”œâ”€ a. è·å–å…ƒæ•°æ®
   â”‚       â”œâ”€ b. æå– PDF å…¨æ–‡
   â”‚       â”œâ”€ c. è·å–æ‰¹æ³¨
   â”‚       â”œâ”€ d. ç»„è£… prompt
   â”‚       â”‚     "æ ¹æ®ä»¥ä¸‹è®ºæ–‡å†…å®¹ï¼Œç”Ÿæˆç»“æ„åŒ–ç¬”è®°..."
   â”‚       â”œâ”€ e. è°ƒç”¨ LLM API
   â”‚       â”‚     response = await llm_client.analyze_paper(
   â”‚       â”‚         title=item['title'],
   â”‚       â”‚         fulltext=fulltext,
   â”‚       â”‚         annotations=annotations
   â”‚       â”‚     )
   â”‚       â”œâ”€ f. è½¬æ¢ Markdown â†’ HTML
   â”‚       â”‚     html = markdown_to_html(response.analysis_markdown)
   â”‚       â”œâ”€ g. åˆ›å»º Zotero ç¬”è®°
   â”‚       â”‚     await data_service.create_note(
   â”‚       â”‚         item_key=item['key'],
   â”‚       â”‚         content=html
   â”‚       â”‚     )
   â”‚       â”œâ”€ h. æ›´æ–°æ£€æŸ¥ç‚¹
   â”‚       â”‚     workflow_state.mark_processed(item['key'])
   â”‚       â”‚     checkpoint_manager.save_state(workflow_state)
   â”‚       â””â”€ i. æŠ¥å‘Šè¿›åº¦
   â”‚             await ctx.report_progress(current=i+1, total=5)
   â”‚
   â””â”€ 5. è¿”å›ç»“æœ
         {
           "success": true,
           "workflow_id": "wf_20260124_123456_abc",
           "processed": 5,
           "failed": 0,
           "notes_created": [...]
         }
```

---

## 5. æ•°æ®æµè½¬

### 5.1 é…ç½®åŠ è½½æµç¨‹

```
å¯åŠ¨æ—¶:
   â”œâ”€ 1. load_config() å‡½æ•°æ‰§è¡Œ
   â”œâ”€ 2. åŠ è½½é¡ºåº (ä¼˜å…ˆçº§ä»é«˜åˆ°ä½):
   â”‚     â”œâ”€ a. ç¯å¢ƒå˜é‡
   â”‚     â”‚     ZOTERO_LOCAL, ZOTERO_API_KEY, ...
   â”‚     â”œâ”€ b. ç‹¬ç«‹é…ç½®æ–‡ä»¶
   â”‚     â”‚     ~/.config/zotero-mcp/config.json
   â”‚     â”œâ”€ c. Claude Desktop é…ç½®
   â”‚     â”‚     ~/Library/Application Support/Claude/claude_desktop_config.json
   â”‚     â””â”€ d. Opencode CLI é…ç½®
   â”‚           ~/.opencode/config.json
   â””â”€ 3. åˆå¹¶æ‰€æœ‰é…ç½®ï¼Œè®¾ç½®å…¨å±€å˜é‡
```

### 5.2 æ•°æ®æºé€‰æ‹©æµç¨‹

```
DataAccessService æ”¶åˆ°è¯·æ±‚
   â†“
å†³ç­–æ ‘:
   â”œâ”€ æ“ä½œç±»å‹ = æœç´¢?
   â”‚   â”œâ”€ æœ¬åœ°æ¨¡å¼ + qmode="everything"?
   â”‚   â”‚   â””â”€ YES â†’ LocalDatabaseClient.search_items()
   â”‚   â””â”€ NO â†’ ZoteroAPIClient.search_items()
   â”‚
   â”œâ”€ æ“ä½œç±»å‹ = è·å–å…ƒæ•°æ®?
   â”‚   â”œâ”€ LocalDatabaseClient å¯ç”¨?
   â”‚   â”‚   â””â”€ YES â†’ LocalDatabaseClient.get_item()
   â”‚   â””â”€ NO â†’ ZoteroAPIClient.get_item()
   â”‚
   â”œâ”€ æ“ä½œç±»å‹ = è·å–å…¨æ–‡?
   â”‚   â”œâ”€ LocalDatabaseClient å¯ç”¨ + å·²ç´¢å¼•?
   â”‚   â”‚   â””â”€ YES â†’ LocalDatabaseClient.get_fulltext()
   â”‚   â””â”€ NO â†’ ZoteroAPIClient.get_fulltext()
   â”‚
   â”œâ”€ æ“ä½œç±»å‹ = è·å–æ³¨é‡Š?
   â”‚   â”œâ”€ BetterBibTeXClient å¯ç”¨?
   â”‚   â”‚   â””â”€ YES â†’ BetterBibTeXClient.get_annotations()
   â”‚   â””â”€ NO â†’ ZoteroAPIClient æˆ– LocalDatabaseClient
   â”‚
   â””â”€ æ“ä½œç±»å‹ = åˆ›å»º/ä¿®æ”¹?
       â””â”€ ZoteroAPIClient (ä»… Web API æ”¯æŒå†™æ“ä½œ)
```

### 5.3 å“åº”æ ¼å¼åŒ–æµç¨‹

```
ä¸šåŠ¡é€»è¾‘è¿”å›åŸå§‹æ•°æ®
   â†“
æ ¹æ® response_format å‚æ•°é€‰æ‹©æ ¼å¼åŒ–å™¨:
   â”œâ”€ format = "markdown"
   â”‚   â””â”€ MarkdownFormatter.format_items(items)
   â”‚       â†’ è¿”å› Markdown æ ¼å¼å­—ç¬¦ä¸²
   â”‚
   â”œâ”€ format = "json"
   â”‚   â””â”€ JSONFormatter.format_items(items)
   â”‚       â†’ è¿”å› JSON æ ¼å¼å­—ç¬¦ä¸²
   â”‚
   â”œâ”€ format = "bibtex"
   â”‚   â””â”€ BibTeXFormatter.format_items(items)
   â”‚       â†’ è¿”å› BibTeX æ ¼å¼å­—ç¬¦ä¸²
   â”‚
   â””â”€ é»˜è®¤ (æ–°ç‰ˆæœ¬)
       â””â”€ è¿”å› Pydantic æ¨¡å‹ (SearchResponse, ItemDetailResponse, ...)
           â†’ FastMCP è‡ªåŠ¨åºåˆ—åŒ–ä¸º JSON
```

---

## 6. å…³é”®æŠ€æœ¯å®ç°

### 6.1 è¯­ä¹‰æœç´¢å®ç°

#### åµŒå…¥æ¨¡å‹é€‰æ‹©

```python
def _get_embedding_function(self):
    """æ ¹æ®é…ç½®é€‰æ‹©åµŒå…¥æ¨¡å‹"""
    model = os.getenv("ZOTERO_EMBEDDING_MODEL", "default")
    
    if model == "openai":
        return OpenAIEmbeddingFunction(
            api_key=os.getenv("OPENAI_API_KEY"),
            model_name=os.getenv("OPENAI_EMBEDDING_MODEL", "text-embedding-3-small")
        )
    
    elif model == "gemini":
        return GeminiEmbeddingFunction(
            api_key=os.getenv("GEMINI_API_KEY"),
            model_name=os.getenv("GEMINI_EMBEDDING_MODEL", "models/text-embedding-004")
        )
    
    else:  # default
        return SentenceTransformerEmbeddingFunction(
            model_name="all-MiniLM-L6-v2"  # å…è´¹æœ¬åœ°æ¨¡å‹
        )
```

#### å‘é‡åŒ–æµç¨‹

```python
def _extract_item_text(self, item: dict, extract_fulltext: bool = False):
    """
    æå–æ¡ç›®æ–‡æœ¬ç”¨äºå‘é‡åŒ–
    
    ç­–ç•¥:
    - åŸºç¡€æ¨¡å¼: æ ‡é¢˜ + æ‘˜è¦ + ä½œè€… + å¹´ä»½
    - å…¨æ–‡æ¨¡å¼: åŸºç¡€å†…å®¹ + PDF å…¨æ–‡å†…å®¹
    """
    parts = []
    
    # æ ‡é¢˜
    parts.append(item['data'].get('title', ''))
    
    # æ‘˜è¦
    abstract = item['data'].get('abstractNote', '')
    if abstract:
        parts.append(abstract)
    
    # ä½œè€…
    creators = format_creators(item['data'].get('creators', []))
    if creators:
        parts.append(creators)
    
    # å…¨æ–‡ (å¯é€‰)
    if extract_fulltext:
        fulltext = self._get_item_fulltext(item['key'])
        if fulltext:
            parts.append(fulltext[:5000])  # é™åˆ¶é•¿åº¦
    
    return " ".join(parts)
```

### 6.2 æ–­ç‚¹ç»­ä¼ å®ç°

#### å·¥ä½œæµçŠ¶æ€æ¨¡å‹

```python
@dataclass
class WorkflowState:
    """å·¥ä½œæµçŠ¶æ€"""
    workflow_id: str
    created_at: str
    updated_at: str
    
    # æ¡ç›®åˆ—è¡¨
    all_item_keys: list[str]
    processed_keys: list[str]
    failed_keys: list[str]
    
    # å…ƒæ•°æ®
    metadata: dict[str, Any]  # é›†åˆåç§°ã€LLM é…ç½®ç­‰
    
    # ç»“æœ
    notes_created: list[dict]  # {"item_key": ..., "note_key": ...}
    
    def get_remaining_items(self, items: list[dict]) -> list[dict]:
        """è·å–æœªå¤„ç†çš„æ¡ç›®"""
        processed_set = set(self.processed_keys + self.failed_keys)
        return [item for item in items if item['key'] not in processed_set]
    
    def mark_processed(self, item_key: str, result: dict):
        """æ ‡è®°ä¸ºå·²å¤„ç†"""
        self.processed_keys.append(item_key)
        self.notes_created.append(result)
    
    def mark_failed(self, item_key: str, error: str):
        """æ ‡è®°ä¸ºå¤±è´¥"""
        self.failed_keys.append(item_key)
```

#### æ£€æŸ¥ç‚¹ç®¡ç†å™¨

```python
class CheckpointManager:
    """æ£€æŸ¥ç‚¹ç®¡ç†å™¨"""
    
    def __init__(self, checkpoint_dir: Path):
        self.checkpoint_dir = checkpoint_dir
        self.checkpoint_dir.mkdir(parents=True, exist_ok=True)
    
    def create_state(self, item_keys: list[str], metadata: dict) -> WorkflowState:
        """åˆ›å»ºæ–°çš„å·¥ä½œæµçŠ¶æ€"""
        workflow_id = f"wf_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{uuid4().hex[:8]}"
        return WorkflowState(
            workflow_id=workflow_id,
            created_at=datetime.now().isoformat(),
            updated_at=datetime.now().isoformat(),
            all_item_keys=item_keys,
            processed_keys=[],
            failed_keys=[],
            metadata=metadata,
            notes_created=[],
        )
    
    def save_state(self, state: WorkflowState):
        """ä¿å­˜å·¥ä½œæµçŠ¶æ€åˆ°ç£ç›˜"""
        state.updated_at = datetime.now().isoformat()
        
        file_path = self.checkpoint_dir / f"{state.workflow_id}.json"
        with open(file_path, 'w') as f:
            json.dump(asdict(state), f, indent=2)
    
    def load_state(self, workflow_id: str) -> WorkflowState:
        """ä»ç£ç›˜åŠ è½½å·¥ä½œæµçŠ¶æ€"""
        file_path = self.checkpoint_dir / f"{workflow_id}.json"
        with open(file_path) as f:
            data = json.load(f)
        return WorkflowState(**data)
```

### 6.3 ç¼“å­˜æœºåˆ¶

```python
from functools import wraps
import hashlib
import json
import time

def cached_tool(ttl_seconds: int = 300):
    """
    å·¥å…·ç¼“å­˜è£…é¥°å™¨
    
    ç¼“å­˜ç­–ç•¥:
    - åŸºäºå‚æ•°çš„ hash ä½œä¸º key
    - TTL (Time To Live) è¿‡æœŸæœºåˆ¶
    - å­˜å‚¨åœ¨å†…å­˜ä¸­ (é‡å¯å¤±æ•ˆ)
    """
    cache = {}
    
    def decorator(func):
        @wraps(func)
        async def wrapper(params, ctx):
            # ç”Ÿæˆç¼“å­˜ key
            cache_key = hashlib.md5(
                json.dumps(params.dict(), sort_keys=True).encode()
            ).hexdigest()
            
            # æ£€æŸ¥ç¼“å­˜
            if cache_key in cache:
                cached_data, timestamp = cache[cache_key]
                if time.time() - timestamp < ttl_seconds:
                    return cached_data
            
            # æ‰§è¡Œå‡½æ•°
            result = await func(params, ctx)
            
            # å­˜å…¥ç¼“å­˜
            cache[cache_key] = (result, time.time())
            
            return result
        
        return wrapper
    return decorator
```

### 6.4 æ€§èƒ½ç›‘æ§

```python
from functools import wraps
import time
import logging

logger = logging.getLogger(__name__)

def monitored_tool(func):
    """
    æ€§èƒ½ç›‘æ§è£…é¥°å™¨
    
    è®°å½•:
    - å·¥å…·è°ƒç”¨æ¬¡æ•°
    - æ‰§è¡Œæ—¶é—´
    - é”™è¯¯ç‡
    """
    @wraps(func)
    async def wrapper(params, ctx):
        start_time = time.time()
        
        try:
            result = await func(params, ctx)
            
            # è®°å½•æˆåŠŸ
            duration = time.time() - start_time
            logger.info(
                f"Tool {func.__name__} completed in {duration:.2f}s",
                extra={
                    'tool': func.__name__,
                    'duration': duration,
                    'status': 'success'
                }
            )
            
            return result
        
        except Exception as e:
            # è®°å½•å¤±è´¥
            duration = time.time() - start_time
            logger.error(
                f"Tool {func.__name__} failed after {duration:.2f}s: {e}",
                extra={
                    'tool': func.__name__,
                    'duration': duration,
                    'status': 'error',
                    'error': str(e)
                }
            )
            raise
    
    return wrapper
```

---

## 7. æµ‹è¯•æŒ‡å—

### 7.1 ç¯å¢ƒå‡†å¤‡

#### å‰ç½®æ¡ä»¶

1. **å®‰è£… Zotero**
   - ä¸‹è½½å¹¶å®‰è£… Zotero 7+
   - å¯åŠ¨ Zotero
   - åœ¨é¦–é€‰é¡¹ä¸­å¯ç”¨: "Allow other applications on this computer to communicate with Zotero"

2. **å®‰è£… Better BibTeX æ’ä»¶** (å¯é€‰ï¼Œæ¨è)
   - è®¿é—®: https://retorque.re/zotero-better-bibtex/installation/
   - ä¸‹è½½ .xpi æ–‡ä»¶
   - åœ¨ Zotero ä¸­å®‰è£…

3. **å®‰è£… Zotero MCP**
   ```bash
   # ä½¿ç”¨ uv (æ¨è)
   uv tool install git+https://github.com/54yyyu/zotero-mcp.git
   
   # æˆ–ä½¿ç”¨ pip
   pip install git+https://github.com/54yyyu/zotero-mcp.git
   ```

4. **é…ç½® Zotero MCP**
   ```bash
   # è¿è¡Œé…ç½®å‘å¯¼
   zotero-mcp setup
   
   # é€‰æ‹©é…ç½®:
   # 1. Zotero è¿æ¥æ–¹å¼: Local (æœ¬åœ°) æˆ– Web API (è¿œç¨‹)
   # 2. è¯­ä¹‰æœç´¢: é€‰æ‹©åµŒå…¥æ¨¡å‹ (default/openai/gemini)
   # 3. è‡ªåŠ¨æ›´æ–°é¢‘ç‡: manual/startup/daily
   ```

### 7.2 åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯• 1: æœç´¢åŠŸèƒ½

**æµ‹è¯•æœ¬åœ°æœç´¢**:
```bash
# 1. ç¡®ä¿ Zotero æ­£åœ¨è¿è¡Œ
# 2. åœ¨ AI åŠ©æ‰‹ä¸­è¾“å…¥:

"æœç´¢æˆ‘çš„åº“ä¸­å…³äºæœºå™¨å­¦ä¹ çš„è®ºæ–‡"

# é¢„æœŸç»“æœ:
# - è¿”å›åŒ…å« "machine learning" çš„è®ºæ–‡åˆ—è¡¨
# - æ˜¾ç¤ºæ ‡é¢˜ã€ä½œè€…ã€å¹´ä»½
# - æ˜¾ç¤ºæ€»æ•°å’Œåˆ†é¡µä¿¡æ¯
```

**æµ‹è¯•æ ‡ç­¾è¿‡æ»¤**:
```bash
"æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°ä¸º #AI ä½†ä¸åŒ…å« #Draft çš„è®ºæ–‡"

# é¢„æœŸç»“æœ:
# - åªè¿”å›æœ‰ "AI" æ ‡ç­¾ä¸”æ²¡æœ‰ "Draft" æ ‡ç­¾çš„è®ºæ–‡
```

#### æµ‹è¯• 2: å…ƒæ•°æ®è·å–

```bash
"è·å–è®ºæ–‡ ABC123 çš„è¯¦ç»†ä¿¡æ¯"

# é¢„æœŸç»“æœ:
# - è¿”å›å®Œæ•´å…ƒæ•°æ® (æ ‡é¢˜ã€ä½œè€…ã€æ‘˜è¦ã€DOIã€å‡ºç‰ˆä¿¡æ¯ç­‰)
```

**æµ‹è¯• BibTeX å¯¼å‡º**:
```bash
"å¯¼å‡ºè®ºæ–‡ ABC123 çš„ BibTeX å¼•ç”¨"

# é¢„æœŸç»“æœ:
# - è¿”å›æ ¼å¼åŒ–çš„ BibTeX æ¡ç›®
```

#### æµ‹è¯• 3: å…¨æ–‡æå–

```bash
"è·å–è®ºæ–‡ ABC123 çš„å…¨æ–‡å†…å®¹"

# é¢„æœŸç»“æœ:
# - å¦‚æœæœ‰ PDF: è¿”å›æå–çš„æ–‡æœ¬å†…å®¹
# - å¦‚æœæ²¡æœ‰ PDF: è¿”å›é”™è¯¯æç¤º
```

#### æµ‹è¯• 4: æ³¨é‡Šæå–

```bash
"è·å–è®ºæ–‡ ABC123 çš„æ‰€æœ‰æ‰¹æ³¨"

# é¢„æœŸç»“æœ:
# - è¿”å›é«˜äº®ã€è¯„è®ºã€ç¬”è®°åˆ—è¡¨
# - åŒ…å«é¡µç ã€é¢œè‰²ã€å†…å®¹
```

### 7.3 è¯­ä¹‰æœç´¢æµ‹è¯•

#### æµ‹è¯• 5: åˆå§‹åŒ–å‘é‡æ•°æ®åº“

```bash
# 1. æ„å»ºæ•°æ®åº“ (å¿«é€Ÿæ¨¡å¼ï¼Œä»…å…ƒæ•°æ®)
zotero-mcp update-db

# é¢„æœŸç»“æœ:
# - æ˜¾ç¤ºå¤„ç†è¿›åº¦
# - å®Œæˆåæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯:
#   - items_processed: X
#   - items_added: X
#   - duration_seconds: X

# 2. æ„å»ºæ•°æ®åº“ (å…¨æ–‡æ¨¡å¼)
zotero-mcp update-db --fulltext

# é¢„æœŸç»“æœ:
# - å¤„ç†æ—¶é—´æ›´é•¿
# - ç´¢å¼•åŒ…å« PDF å…¨æ–‡å†…å®¹
```

#### æµ‹è¯• 6: è¯­ä¹‰æŸ¥è¯¢

```bash
"æ‰¾åˆ°ä¸æ·±åº¦å­¦ä¹ åœ¨è®¡ç®—æœºè§†è§‰ä¸­åº”ç”¨ç›¸ä¼¼çš„è®ºæ–‡"

# é¢„æœŸç»“æœ:
# - è¿”å›æ¦‚å¿µç›¸ä¼¼çš„è®ºæ–‡
# - æ¯ä¸ªç»“æœåŒ…å«ç›¸ä¼¼åº¦åˆ†æ•° (0-1)
# - æŒ‰ç›¸ä¼¼åº¦é™åºæ’åˆ—
```

**å¯¹æ¯”æµ‹è¯•**:
```bash
# å…³é”®è¯æœç´¢
"æœç´¢å…³é”®è¯: deep learning computer vision"
# â†’ åªæ‰¾åˆ°æ ‡é¢˜ä¸­åŒ…å«è¿™äº›è¯çš„è®ºæ–‡

# è¯­ä¹‰æœç´¢
"æ‰¾åˆ°ä¸æ·±åº¦å­¦ä¹ åœ¨è®¡ç®—æœºè§†è§‰ä¸­åº”ç”¨ç›¸ä¼¼çš„è®ºæ–‡"
# â†’ æ‰¾åˆ°ç›¸å…³æ¦‚å¿µçš„è®ºæ–‡ï¼ˆå³ä½¿æ²¡æœ‰è¿™äº›å…³é”®è¯ï¼‰
```

#### æµ‹è¯• 7: æ•°æ®åº“çŠ¶æ€æ£€æŸ¥

```bash
zotero-mcp db-status

# é¢„æœŸè¾“å‡º (JSON):
{
  "exists": true,
  "item_count": 523,
  "last_updated": "2024-01-20T13:45:30Z",
  "embedding_model": "openai",
  "model_name": "text-embedding-3-small",
  "fulltext_enabled": true,
  "auto_update": true,
  "update_frequency": "daily"
}
```

### 7.4 æ‰¹é‡åˆ†ææµ‹è¯•

#### æµ‹è¯• 8: å‡†å¤‡åˆ†æ (æ¨¡å¼ A)

```bash
"å‡†å¤‡åˆ†ææœ€è¿‘ 3 ç¯‡è®ºæ–‡"

# AI è°ƒç”¨: zotero_prepare_analysis(source="recent", limit=3)

# é¢„æœŸç»“æœ:
{
  "success": true,
  "total_items": 3,
  "prepared_items": 3,
  "items": [
    {
      "key": "ABC123",
      "title": "...",
      "metadata": {...},
      "fulltext": "...",
      "annotations": [...]
    },
    ...
  ]
}

# åç»­: AI å¯ä»¥é€ä¸ªå®¡æ ¸å¹¶ç”Ÿæˆåˆ†æ
```

#### æµ‹è¯• 9: è‡ªåŠ¨æ‰¹é‡åˆ†æ (æ¨¡å¼ B)

**å‰æ**: è®¾ç½® LLM API Key
```bash
export DEEPSEEK_API_KEY=sk-xxx
# æˆ–
export OPENAI_API_KEY=sk-xxx
```

**æµ‹è¯•å‘½ä»¤**:
```bash
"æ‰¹é‡åˆ†ææœ€è¿‘ 2 ç¯‡è®ºæ–‡ï¼Œä½¿ç”¨ DeepSeek"

# AI è°ƒç”¨: zotero_batch_analyze_pdfs(
#   source="recent",
#   limit=2,
#   llm_provider="deepseek"
# )

# é¢„æœŸæµç¨‹:
# 1. åˆ›å»ºå·¥ä½œæµ (workflow_id: wf_20260124_...)
# 2. é€ä¸ªåˆ†æ:
#    - è·å–å…ƒæ•°æ®
#    - æå– PDF å…¨æ–‡
#    - è·å–æ‰¹æ³¨
#    - è°ƒç”¨ DeepSeek API
#    - ç”Ÿæˆç»“æ„åŒ–ç¬”è®°
#    - åˆ›å»º Zotero ç¬”è®°
#    - ä¿å­˜æ£€æŸ¥ç‚¹
# 3. è¿”å›ç»“æœ

# é¢„æœŸç»“æœ:
{
  "success": true,
  "workflow_id": "wf_20260124_123456_abc",
  "total_items": 2,
  "processed": 2,
  "failed": 0,
  "notes_created": [
    {"item_key": "ABC123", "note_key": "NOTE1"},
    {"item_key": "DEF456", "note_key": "NOTE2"}
  ]
}
```

#### æµ‹è¯• 10: æ–­ç‚¹ç»­ä¼ 

**æ¨¡æ‹Ÿä¸­æ–­**:
1. å¯åŠ¨æ‰¹é‡åˆ†æ 5 ç¯‡è®ºæ–‡
2. åœ¨å¤„ç†ç¬¬ 3 ç¯‡æ—¶æ‰‹åŠ¨åœæ­¢ (Ctrl+C)

**æ¢å¤æµ‹è¯•**:
```bash
"åˆ—å‡ºæ‰€æœ‰å·¥ä½œæµ"

# AI è°ƒç”¨: zotero_list_workflows()

# é¢„æœŸç»“æœ:
{
  "workflows": [
    {
      "workflow_id": "wf_20260124_123456_abc",
      "status": "incomplete",
      "total": 5,
      "processed": 2,
      "failed": 0,
      "created_at": "2024-01-24T12:34:56Z"
    }
  ]
}

# ç»§ç»­å·¥ä½œæµ:
"ç»§ç»­å·¥ä½œæµ wf_20260124_123456_abc"

# AI è°ƒç”¨: zotero_resume_workflow(
#   workflow_id="wf_20260124_123456_abc"
# )

# é¢„æœŸç»“æœ:
# - ä»ç¬¬ 3 ç¯‡è®ºæ–‡ç»§ç»­
# - ä¸é‡å¤å¤„ç†å‰ 2 ç¯‡
# - å®Œæˆåæ›´æ–°çŠ¶æ€
```

### 7.5 é”™è¯¯å¤„ç†æµ‹è¯•

#### æµ‹è¯• 11: æ— æ•ˆæ¡ç›® Key

```bash
"è·å–è®ºæ–‡ INVALID_KEY çš„ä¿¡æ¯"

# é¢„æœŸç»“æœ:
{
  "success": false,
  "error": "Item not found: INVALID_KEY",
  "item_key": "INVALID_KEY"
}
```

#### æµ‹è¯• 12: API é…ç½®é”™è¯¯

```bash
# 1. æ¸…ç©ºç¯å¢ƒå˜é‡
unset ZOTERO_API_KEY
unset ZOTERO_LOCAL

# 2. å°è¯•æœç´¢
"æœç´¢æœºå™¨å­¦ä¹ "

# é¢„æœŸç»“æœ:
{
  "success": false,
  "error": "Zotero configuration missing. Please run 'zotero-mcp setup'"
}
```

#### æµ‹è¯• 13: æ•°æ®åº“æœªåˆå§‹åŒ–

```bash
# 1. åˆ é™¤å‘é‡æ•°æ®åº“
rm -rf ~/.config/zotero-mcp/chroma_db

# 2. å°è¯•è¯­ä¹‰æœç´¢
"è¯­ä¹‰æœç´¢: æ·±åº¦å­¦ä¹ "

# é¢„æœŸç»“æœ:
{
  "success": false,
  "error": "Semantic search database not initialized. Run 'zotero-mcp update-db'"
}
```

### 7.6 æ€§èƒ½æµ‹è¯•

#### æµ‹è¯• 14: å¤§æ‰¹é‡æœç´¢

```bash
# æœç´¢ 100 æ¡ç»“æœ
"æœç´¢æœºå™¨å­¦ä¹ ç›¸å…³è®ºæ–‡ï¼Œè¿”å› 100 æ¡"

# ç›‘æ§æŒ‡æ ‡:
# - å“åº”æ—¶é—´ (< 5s ä¸ºä¼˜ç§€)
# - å†…å­˜ä½¿ç”¨
# - ç¼“å­˜å‘½ä¸­ç‡
```

#### æµ‹è¯• 15: æ‰¹é‡åˆ†ææ€§èƒ½

```bash
# åˆ†æ 20 ç¯‡è®ºæ–‡
"æ‰¹é‡åˆ†ææœ€è¿‘ 20 ç¯‡è®ºæ–‡"

# ç›‘æ§æŒ‡æ ‡:
# - æ¯ç¯‡è®ºæ–‡å¤„ç†æ—¶é—´ (çº¦ 10-30sï¼Œå–å†³äº LLM)
# - æ€»æ—¶é—´ (çº¦ 3-10 åˆ†é’Ÿ)
# - æ£€æŸ¥ç‚¹ä¿å­˜é¢‘ç‡
# - LLM API è°ƒç”¨æ¬¡æ•°
```

---

## 8. å¸¸è§é—®é¢˜æ’æŸ¥

### 8.1 è¿æ¥é—®é¢˜

**é—®é¢˜**: "No results found" æˆ– "Can't connect to Zotero"

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤ Zotero æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥æœ¬åœ° API æ˜¯å¦å¯ç”¨:
   - Zotero â†’ é¦–é€‰é¡¹ â†’ é«˜çº§ â†’ "å…è®¸å…¶ä»–åº”ç”¨ç¨‹åº..."
3. æµ‹è¯•è¿æ¥:
   ```bash
   curl http://localhost:23119/connector/ping
   # é¢„æœŸ: pong
   ```
4. æŸ¥çœ‹é…ç½®:
   ```bash
   zotero-mcp setup-info
   # æ£€æŸ¥ ZOTERO_LOCAL æ˜¯å¦ä¸º "true"
   ```

### 8.2 è¯­ä¹‰æœç´¢é—®é¢˜

**é—®é¢˜**: "Semantic search returns no results"

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€:
   ```bash
   zotero-mcp db-status
   ```
2. å¦‚æœ `exists: false`:
   ```bash
   zotero-mcp update-db
   ```
3. å¦‚æœ `item_count: 0`:
   - æ£€æŸ¥ Zotero åº“æ˜¯å¦ä¸ºç©º
   - å°è¯•å¼ºåˆ¶é‡å»º:
     ```bash
     zotero-mcp update-db --force-rebuild
     ```

**é—®é¢˜**: "Database update takes too long"

**è§£å†³æ–¹æ¡ˆ**:
1. æµ‹è¯•å°æ‰¹é‡:
   ```bash
   zotero-mcp update-db --limit 10
   ```
2. ä¸ä½¿ç”¨å…¨æ–‡æ¨¡å¼ (æ›´å¿«):
   ```bash
   zotero-mcp update-db  # ä¸åŠ  --fulltext
   ```
3. æ£€æŸ¥ç½‘ç»œ (å¦‚æœä½¿ç”¨ OpenAI/Gemini åµŒå…¥)

### 8.3 æ‰¹é‡åˆ†æé—®é¢˜

**é—®é¢˜**: "No LLM provider API key found"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è®¾ç½®è‡³å°‘ä¸€ä¸ª API Key
export DEEPSEEK_API_KEY=sk-xxx
# æˆ–
export OPENAI_API_KEY=sk-xxx
# æˆ–
export GEMINI_API_KEY=xxx

# éªŒè¯é…ç½®
zotero-mcp setup-info
```

**é—®é¢˜**: "Analysis returns empty notes"

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤ PDF å·²ç´¢å¼•:
   ```bash
   zotero-mcp update-db --fulltext
   ```
2. æ‰‹åŠ¨æµ‹è¯•å…¨æ–‡æå–:
   ```bash
   # åœ¨ Claude ä¸­:
   "è·å–è®ºæ–‡ ABC123 çš„å…¨æ–‡"
   # æ£€æŸ¥æ˜¯å¦è¿”å›å†…å®¹
   ```
3. æ£€æŸ¥ LLM API é…é¢

**é—®é¢˜**: "Workflow interrupted"

**æ¢å¤æ­¥éª¤**:
1. æŸ¥çœ‹æ‰€æœ‰å·¥ä½œæµ:
   ```bash
   # åœ¨ Claude ä¸­:
   "åˆ—å‡ºæ‰€æœ‰å·¥ä½œæµ"
   ```
2. æ‰¾åˆ°æœªå®Œæˆçš„ workflow_id
3. ç»§ç»­:
   ```bash
   "ç»§ç»­å·¥ä½œæµ wf_xxx"
   ```
4. æ£€æŸ¥æ£€æŸ¥ç‚¹æ–‡ä»¶:
   ```bash
   ls ~/.config/zotero-mcp/workflows/
   cat ~/.config/zotero-mcp/workflows/wf_xxx.json
   ```

### 8.4 æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**: "æœç´¢å“åº”æ…¢"

**ä¼˜åŒ–å»ºè®®**:
1. å¯ç”¨ç¼“å­˜ (é»˜è®¤å·²å¯ç”¨)
2. ä½¿ç”¨æœ¬åœ°æ¨¡å¼ (æ¯” Web API å¿«)
3. è¯­ä¹‰æœç´¢: ä½¿ç”¨é»˜è®¤æ¨¡å‹ (æœ¬åœ°ï¼Œæœ€å¿«)
4. å®šæœŸæ›´æ–°æ•°æ®åº“ (é¿å…å¯åŠ¨æ—¶æ›´æ–°)

**é—®é¢˜**: "å†…å­˜å ç”¨é«˜"

**ä¼˜åŒ–å»ºè®®**:
1. é™åˆ¶æœç´¢ç»“æœæ•°é‡:
   ```python
   # é»˜è®¤ limit=20ï¼Œä¸è¦è¶…è¿‡ 100
   ```
2. æ‰¹é‡åˆ†æ: åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ 10-20 ç¯‡
3. æ¸…ç†æ—§çš„å·¥ä½œæµçŠ¶æ€:
   ```bash
   # åˆ é™¤ 30 å¤©å‰çš„æ£€æŸ¥ç‚¹
   find ~/.config/zotero-mcp/workflows/ -mtime +30 -delete
   ```

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„èŒè´£åˆ†ç¦» (Tools â†’ Services â†’ Clients)
2. **ç±»å‹å®‰å…¨**: å…¨é¢ä½¿ç”¨ Pydantic è¿›è¡Œæ•°æ®éªŒè¯
3. **å¤šæ•°æ®æº**: è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ•°æ®æº (Local DB / Web API / Better BibTeX)
4. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°å·¥å…·ã€æ–°æ•°æ®æºã€æ–°æ ¼å¼åŒ–å™¨
5. **å®¹é”™æ€§**: ç»Ÿä¸€é”™è¯¯å¤„ç†ã€é™çº§ç­–ç•¥ã€æ–­ç‚¹ç»­ä¼ 

### 9.2 å…³é”®æŠ€æœ¯äº®ç‚¹

1. **è¯­ä¹‰æœç´¢**: åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„ AI æœç´¢
2. **æ‰¹é‡åˆ†æ**: LLM é©±åŠ¨çš„è‡ªåŠ¨åŒ–å­¦æœ¯ç¬”è®°ç”Ÿæˆ
3. **æ–­ç‚¹ç»­ä¼ **: å·¥ä½œæµçŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤
4. **ç¼“å­˜æœºåˆ¶**: æå‡é‡å¤æŸ¥è¯¢æ€§èƒ½
5. **MCP åè®®**: æ ‡å‡†åŒ–çš„ AI å·¥å…·æ¥å£

### 9.3 åç»­æµ‹è¯•é‡ç‚¹

1. **åŠŸèƒ½å®Œæ•´æ€§**: éªŒè¯æ‰€æœ‰ 22 ä¸ªå·¥å…·æ­£å¸¸å·¥ä½œ
2. **æ•°æ®å‡†ç¡®æ€§**: ç¡®ä¿å…ƒæ•°æ®ã€å…¨æ–‡ã€æ³¨é‡Šæå–æ­£ç¡®
3. **æ€§èƒ½åŸºå‡†**: å»ºç«‹å“åº”æ—¶é—´ã€ååé‡åŸºçº¿
4. **é”™è¯¯æ¢å¤**: æµ‹è¯•å„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†
5. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´çš„ç”¨æˆ·å·¥ä½œæµæµ‹è¯•

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

```bash
# Zotero è¿æ¥
ZOTERO_LOCAL=true                    # ä½¿ç”¨æœ¬åœ° API
ZOTERO_API_KEY=xxx                   # Web API Key
ZOTERO_LIBRARY_ID=xxx                # Library ID
ZOTERO_LIBRARY_TYPE=user             # user æˆ– group
ZOTERO_DB_PATH=/path/to/zotero.sqlite  # è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„

# è¯­ä¹‰æœç´¢
ZOTERO_EMBEDDING_MODEL=default       # default/openai/gemini
OPENAI_API_KEY=sk-xxx
OPENAI_EMBEDDING_MODEL=text-embedding-3-small
OPENAI_BASE_URL=https://api.openai.com/v1
GEMINI_API_KEY=xxx
GEMINI_EMBEDDING_MODEL=models/text-embedding-004
GEMINI_BASE_URL=xxx

# æ‰¹é‡åˆ†æ
DEEPSEEK_API_KEY=sk-xxx
DEEPSEEK_MODEL=deepseek-chat
OPENAI_MODEL=gpt-4o-mini
GEMINI_MODEL=gemini-2.0-flash-exp
```

### B. é…ç½®æ–‡ä»¶ä½ç½®

```
# ä¸»é…ç½®æ–‡ä»¶
~/.config/zotero-mcp/config.json

# å‘é‡æ•°æ®åº“
~/.config/zotero-mcp/chroma_db/

# å·¥ä½œæµæ£€æŸ¥ç‚¹
~/.config/zotero-mcp/workflows/

# Opencode CLI é…ç½®
~/.opencode/config.json
```

### C. å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# æ˜¾ç¤ºç‰ˆæœ¬
zotero-mcp version

# æ˜¾ç¤ºå®‰è£…ä¿¡æ¯
zotero-mcp setup-info

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
zotero-mcp db-status

# é‡æ–°æ„å»ºæ•°æ®åº“
zotero-mcp update-db --force-rebuild --fulltext

# æµ‹è¯• Zotero è¿æ¥
curl http://localhost:23119/connector/ping
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-24  
**ç»´æŠ¤è€…**: Zotero MCP å¼€å‘å›¢é˜Ÿ
