
╭─── Claude Code v2.1.23 ──────────────────────────────────────────────────────╮
│                                                    │ Tips for getting        │
│                 Welcome back 卜式!                 │ started                 │
│                                                    │ ✔ Run /init to create … │
│                       ▐▛███▜▌                      │ ─────────────────────── │
│                      ▝▜█████▛▘                     │ Recent activity         │
│                        ▘▘ ▝▝                       │ No recent activity      │
│                                                    │                         │
│   Opus 4.5 · Claude Pro · liuchzzyy@gmail.com's    │                         │
│   Organization                                     │                         │
│               E:\Desktop\zotero-mcp                │                         │
╰──────────────────────────────────────────────────────────────────────────────╯

╭──────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                            │
│                                                                              │
│ Plan: Fix auto-analyze.yml and optimize analysis scripts                     │
│                                                                              │
│ Problems Found                                                               │
│                                                                              │
│ Critical (workflow will fail or not trigger)                                 │
│                                                                              │
│ 1. analyze-new-items schedule condition wrong: Line 44 checks                │
│ github.event.schedule == '0 22 * * *' but the actual cron is '0 17 * * *'    │
│ (line 9). The scheduled trigger will NEVER run this job.                     │
│ 2. organize-existing-items.py ignores MAX_ITEMS and DRY_RUN env vars: The    │
│ workflow passes MAX_ITEMS and DRY_RUN as env vars (lines 146-147), but the   │
│ script hardcodes MAX_ITEMS = None (line 46) and never reads DRY_RUN. The     │
│ workflow inputs have no effect.                                              │
│ 3. organize-existing_items.py ignores DEBUG env var: No debug logging toggle │
│  despite the workflow passing it.                                            │
│                                                                              │
│ Medium (robustness / code quality)                                           │
│                                                                              │
│ 4. check_has_pdf duplicated 3x: Defined in utils/helpers.py,                 │
│ analyze_new_items.py:58, and organize_existing_items.py:49. Same logic       │
│ copy-pasted.                                                                 │
│ 5. organize_existing_items.py doesn't use WorkflowService: Manually          │
│ reimplements LLM calling, note creation, and progress tracking without       │
│ checkpoint support. Missing: note beautification (beautify_ai_note), LLM     │
│ provider tag on notes, checkpoint/resume.                                    │
│ 6. No $GITHUB_STEP_SUMMARY output in either job — no quick visibility in     │
│ GitHub Actions UI.                                                           │
│ 7. analyze-new-items moves items by slicing                                  │
│ items_to_process[:result.processed] (line 339-341): This assumes processed   │
│ items map 1:1 in order to the input list, which is fragile. The              │
│ WorkflowService.batch_analyze() returns results with per-item status —       │
│ should use that instead.                                                     │
│ 8. Unused check_has_tags in analyze_new_items.py: Defined (line 83) but      │
│ never called — dead code.                                                    │
│                                                                              │
│ Low                                                                          │
│                                                                              │
│ 9. analyze-new-items uses always() && in its if condition — unnecessary      │
│ since there are no needs dependencies.                                       │
│                                                                              │
│ Changes                                                                      │
│                                                                              │
│ 1. Fix workflow YAML (.github/workflows/auto-analyze.yml)                    │
│                                                                              │
│ [x] Fix schedule condition: '0 22 * * *' → '0 17 * * *' on line 44           │
│ [x] Remove always() && from analyze-new-items condition (no needs, so        │
│ always() is redundant)                                                       │
│ [x] Add $GITHUB_STEP_SUMMARY output to both jobs                             │
│ [x] Wire DEBUG env var — already handled in scripts for analyze_new_items.py,│
│ need to add to organize_existing_items.py                                    │
│                                                                              │
│ 2. Fix organize_existing_items.py env var handling                           │
│                                                                              │
│ [x] Read MAX_ITEMS, DRY_RUN, DEBUG from environment (like analyze_new_items. │
│ py does)                                                                     │
│ [x] Add debug logging toggle                                                 │
│ [x] Add dry-run support: skip note deletion, skip LLM analysis, skip tagging │
│ — just print what would happen                                               │
│                                                                              │
│ 3. Refactor organize_existing_items.py to use WorkflowService                │
│                                                                              │
│ [x] Replace manual LLM calling loop (lines 364-446) with                     │
│ workflow_service.batch_analyze(), which handles: beautification, LLM         │
│ provider tagging, checkpointing, progress callbacks                          │
│ [x] Remove manual llm_client initialization, markdown_to_html, and           │
│ create_note calls                                                            │
│ [x] Keep the pre-step of deleting old notes (WorkflowService doesn't handle  │
│ this)                                                                        │
│                                                                              │
│ 4. Deduplicate check_has_pdf / remove dead code                              │
│                                                                              │
│ [x] Both scripts: replace local check_has_pdf with import from               │
│ utils/helpers.py                                                             │
│ [x] analyze_new_items.py: remove unused check_has_tags function              │
│ [x] organize_existing_items.py: remove local check_has_notes (use            │
│ utils/helpers.py)                                                            │
│                                                                              │
│ 5. Fix item-move logic in analyze_new_items.py                               │
│                                                                              │
│ [x] Use result.results (list of ItemAnalysisResult) from batch_analyze() to  │
│ determine which items were actually processed, instead of slicing by count.  │
│                                                                              │
│ Files to Modify                                                              │
│                                                                              │
│ 1. .github/workflows/auto-analyze.yml — fix schedule, step summary           │
│ 2. src/scripts/analyze_new_items.py — deduplicate helpers, fix item-move     │
│ logic, remove dead code                                                      │
│ 3. src/scripts/organize_existing_items.py — env vars, use WorkflowService,   │
│ deduplicate helpers                                                          │
│ 4. src/zotero_mcp/utils/helpers.py — no changes needed (already has          │
│ check_has_pdf, check_has_notes)                                              │
│                                                                              │
│ Verification                                                                 │
│                                                                              │
│ 1. uv run ruff check src/ — lint clean                                       │
│ 2. uv run pytest — tests pass                                                │
│ 3. Manual review of YAML schedule conditions match crons                     │
╰──────────────────────────────────────────────────────────────────────────────╯
