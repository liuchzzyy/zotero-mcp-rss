"""
Template configuration for AI analysis.

Supports loading analysis questions and templates from environment variables
or configuration files.
"""

from typing import Any

from zotero_mcp.utils.config import get_config as load_config

# -------------------- Default Templates --------------------


DEFAULT_ANALYSIS_QUESTIONS = [
    "è¿™ç¯‡è®ºæ–‡çš„ä¸»è¦ç ”ç©¶é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ",
    "å¼•ç”¨çš„æ–‡çŒ®æ˜¯å¦æœ€æ–°ã€å…¨é¢ï¼Ÿä»¥å¾€æ–‡çŒ®æœ‰ä»€ä¹ˆä¸è¶³ï¼Ÿ",
    "æœ¬ç ”ç©¶èšç„¦çš„é—®é¢˜ã€é€»è¾‘æ€è·¯ã€å¯è¡Œæ€§å’Œå¯é æ€§å¦‚ä½•ï¼Ÿ",
    "ä½œè€…é€‰é¢˜è§’åº¦æ˜¯å¦æ–°é¢–ï¼Ÿæœ‰ä»€ä¹ˆä»·å€¼ï¼Ÿ",
    "æå‡ºäº†ä»€ä¹ˆæ–°çš„ç§‘å­¦é—®é¢˜ï¼Ÿ",
    "åœ¨åˆ¶å¤‡æ–¹æ³•ä¸Šæœ‰ä»€ä¹ˆåˆ›æ–°ï¼Ÿ",
    "ç ”ç©¶æ€è·¯æœ‰ä½•ç‹¬ç‰¹ä¹‹å¤„ï¼Ÿ",
    "ä½¿ç”¨äº†ä»€ä¹ˆæ–°çš„ç ”ç©¶å·¥å…·æˆ–æŠ€æœ¯ï¼Ÿ",
    "åœ¨ç†è®ºæ–¹é¢æœ‰ä½•è´¡çŒ®ï¼Ÿ",
    "å…³é”®çš„åˆ¶å¤‡æ–¹æ³•å’Œæ­¥éª¤æ˜¯ä»€ä¹ˆï¼Ÿ",
    "ä½¿ç”¨äº†å“ªäº›è¡¨å¾æ–¹æ³•ï¼Ÿä¸»è¦ç»“æžœæ˜¯ä»€ä¹ˆï¼Ÿ",
    "å…³é”®æ€§èƒ½æ•°æ®å’ŒæŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ",
    "ä½œè€…æå‡ºçš„æœºåˆ¶è§£é‡Šæ˜¯ä»€ä¹ˆï¼Ÿ",
    "ç†è®ºåŸºç¡€å’Œæ¨¡åž‹æ˜¯ä»€ä¹ˆï¼Ÿ",
    "è¿™ç¯‡è®ºæ–‡æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œä¸è¶³ï¼Ÿ",
]

DEFAULT_ANALYSIS_TEMPLATE = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘ç ”æ–‡çŒ®åˆ†æžåŠ©æ‰‹ã€‚è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹è®ºæ–‡å†…å®¹ï¼Œå¹¶æŒ‰ç…§æŒ‡å®šçš„ç»“æž„è¿›è¡Œæ·±å…¥ã€å…¨é¢çš„åˆ†æžã€‚

## è®ºæ–‡åŸºæœ¬ä¿¡æ¯

- **æ ‡é¢˜**: {title}
- **ä½œè€…**: {authors}
- **æœŸåˆŠ**: {journal}
- **å‘è¡¨æ—¥æœŸ**: {date}
- **DOI**: {doi}

## è®ºæ–‡å…¨æ–‡

{fulltext}

{annotations_section}

---

## åˆ†æžè¦æ±‚

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æž„è¿›è¡Œè¯¦ç»†åˆ†æžï¼Œä»¥ Markdown æ ¼å¼è¿”å›žï¼š

### ðŸ“– ç²—è¯»ç­›é€‰

è¯·ä»Žä»¥ä¸‹ç»´åº¦å¿«é€Ÿè¯„ä¼°è¿™ç¯‡è®ºæ–‡çš„è´¨é‡å’Œé˜…è¯»ä»·å€¼ï¼š
- è®ºæ–‡å‘è¡¨æœŸåˆŠçš„å½±å“åŠ›å’Œé¢†åŸŸåœ°ä½
- ç ”ç©¶é—®é¢˜çš„é‡è¦æ€§å’Œå‰æ²¿æ€§
- æ–¹æ³•å’Œç»“è®ºçš„å¯é æ€§å’Œåˆ›æ–°æ€§
- **ç»“è®º**: æ˜¯å¦å»ºè®®æ·±å…¥é˜…è¯»ï¼Ÿé€‚åˆå“ªç±»ç ”ç©¶è€…ï¼Ÿ

### ðŸ“š å‰è¨€åŠæ–‡çŒ®ç»¼è¿°

#### å¼•ç”¨æ–‡çŒ®è¯„ä¼°
- å¼•ç”¨çš„æ–‡çŒ®æ˜¯å¦**æœ€æ–°**ã€**å…¨é¢**ï¼Ÿ
- ä»¥å¾€æ–‡çŒ®æœ‰ä»€ä¹ˆ**ä¸è¶³**æˆ–**ç ”ç©¶ç©ºç™½**ï¼Ÿ
- ä½œè€…å¦‚ä½•å®šä½æœ¬ç ”ç©¶ä¸Žå‰äººå·¥ä½œçš„å…³ç³»ï¼Ÿ

#### èšç„¦é—®é¢˜
- æœ¬ç ”ç©¶**èšç„¦çš„æ ¸å¿ƒç§‘å­¦é—®é¢˜**æ˜¯ä»€ä¹ˆï¼Ÿ
- ç ”ç©¶çš„**é€»è¾‘æ€è·¯**æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆä»Žé—®é¢˜åˆ°æ–¹æ³•åˆ°ç»“è®ºçš„å®Œæ•´é“¾æ¡ï¼‰
- **å¯è¡Œæ€§**ï¼šæ–¹æ³•è®¾è®¡æ˜¯å¦åˆç†ï¼ŸæŠ€æœ¯è·¯çº¿æ˜¯å¦å¯è¡Œï¼Ÿ
- **å¯é æ€§**ï¼šå®žéªŒè®¾è®¡æ˜¯å¦ä¸¥è°¨ï¼Ÿå¯¹ç…§ç»„è®¾ç½®æ˜¯å¦åˆç†ï¼Ÿ

#### é€‰é¢˜æ–°é¢–æ€§
- ä½œè€…é€‰é¢˜è§’åº¦æ˜¯å¦**æ–°é¢–**ï¼Ÿ
- è¿™é¡¹ç ”ç©¶æœ‰ä»€ä¹ˆ**ç§‘å­¦ä»·å€¼**å’Œ**åº”ç”¨å‰æ™¯**ï¼Ÿ

### ðŸ’¡ åˆ›æ–°ç‚¹

è¯·ä»Žä»¥ä¸‹äº”ä¸ªç»´åº¦åˆ†æžåˆ›æ–°ç‚¹ï¼š

#### ç§‘å­¦é—®é¢˜
- æå‡ºäº†ä»€ä¹ˆæ–°çš„ç§‘å­¦é—®é¢˜æˆ–ç ”ç©¶è§†è§’ï¼Ÿ

#### åˆ¶å¤‡æ–¹æ³•
- åœ¨ææ–™åˆ¶å¤‡æˆ–æ ·å“å‡†å¤‡ä¸Šæœ‰ä»€ä¹ˆåˆ›æ–°ï¼Ÿ
- æ˜¯å¦å¼€å‘äº†æ–°çš„åˆæˆè·¯çº¿æˆ–å·¥è‰ºï¼Ÿ

#### ç ”ç©¶æ€è·¯
- ç ”ç©¶è®¾è®¡æœ‰ä½•ç‹¬ç‰¹ä¹‹å¤„ï¼Ÿ
- æ˜¯å¦é‡‡ç”¨äº†æ–°çš„ç ”ç©¶èŒƒå¼æˆ–ç­–ç•¥ï¼Ÿ

#### ç ”ç©¶å·¥å…·
- ä½¿ç”¨äº†ä»€ä¹ˆæ–°çš„ç ”ç©¶å·¥å…·ã€æŠ€æœ¯æˆ–è¡¨å¾æ‰‹æ®µï¼Ÿ
- æ˜¯å¦å¼€å‘äº†æ–°çš„æµ‹è¯•æ–¹æ³•æˆ–åˆ†æžæ‰‹æ®µï¼Ÿ

#### ç ”ç©¶ç†è®º
- åœ¨ç†è®ºå±‚é¢æœ‰ä½•è´¡çŒ®ï¼Ÿ
- æ˜¯å¦æå‡ºäº†æ–°çš„æ¨¡åž‹ã€æœºåˆ¶è§£é‡Šæˆ–ç†è®ºæ¡†æž¶ï¼Ÿ

---

### âœ¨ ç¬”è®°åŽŸå­åŒ–

ä»¥ä¸‹éƒ¨åˆ†è¯·**æå–å…·ä½“æ•°æ®å’Œå…³é”®ä¿¡æ¯**ï¼Œä¾¿äºŽåŽç»­å¼•ç”¨ï¼š

#### ðŸ”§ åˆ¶å¤‡
- **åŽŸæ–™/å‰é©±ä½“**: åˆ—å‡ºå…³é”®ææ–™å’ŒåŒ–å­¦è¯•å‰‚
- **åˆ¶å¤‡æ­¥éª¤**: ç®€è¦æè¿°æ ¸å¿ƒå·¥è‰ºæµç¨‹ï¼ˆæ¸©åº¦ã€æ—¶é—´ã€æ°”æ°›ç­‰å…³é”®å‚æ•°ï¼‰
- **å…³é”®æ¡ä»¶**: å½±å“ç»“æžœçš„å…³é”®å®žéªŒæ¡ä»¶

#### ðŸ“Š è¡¨å¾
- **è¡¨å¾æ–¹æ³•**: ä½¿ç”¨äº†å“ªäº›è¡¨å¾æŠ€æœ¯ï¼Ÿï¼ˆXRD, SEM, TEM, XPS, BETç­‰ï¼‰
- **ä¸»è¦ç»“æžœ**: æ¯ç§è¡¨å¾æ–¹æ³•å¾—åˆ°çš„å…³é”®ç»“è®º
- **æ•°æ®æ”¯æŒ**: æå–å…³é”®çš„æ•°å€¼æ•°æ®ï¼ˆå¦‚æ™¶æ ¼å¸¸æ•°ã€ç²’å¾„ã€æ¯”è¡¨é¢ç§¯ç­‰ï¼‰

#### âš¡ æ€§èƒ½
- **æ€§èƒ½æŒ‡æ ‡**: åˆ—å‡ºå…³é”®æ€§èƒ½å‚æ•°ï¼ˆå¦‚æ´»æ€§ã€é€‰æ‹©æ€§ã€ç¨³å®šæ€§ã€æ•ˆçŽ‡ç­‰ï¼‰
- **å…·ä½“æ•°å€¼**: æå–å‡†ç¡®çš„æ•°å€¼å’Œå•ä½
- **å¯¹æ¯”åŸºå‡†**: ä¸Žæ–‡çŒ®æŠ¥é“æˆ–å•†ä¸šæ ‡å‡†çš„å¯¹æ¯”ç»“æžœ
- **ä¼˜åŠ¿ä½“çŽ°**: æ€§èƒ½ä¼˜åŠ¿ä½“çŽ°åœ¨å“ªäº›æ–¹é¢ï¼Ÿ

#### ðŸ”¬ æœºåˆ¶
- **æœºåˆ¶å‡è®¾**: ä½œè€…æå‡ºçš„ååº”æœºåˆ¶æˆ–ä½œç”¨æœºç†
- **è¯æ®æ”¯æŒ**: å“ªäº›å®žéªŒæ•°æ®æˆ–è¡¨å¾ç»“æžœæ”¯æŒè¿™ä¸€æœºåˆ¶ï¼Ÿ
- **å…³é”®æ­¥éª¤**: æœºåˆ¶ä¸­çš„å…³é”®ååº”æ­¥éª¤æˆ–ç‰©ç†åŒ–å­¦è¿‡ç¨‹
- **äº‰è®®ç‚¹**: æ˜¯å¦å­˜åœ¨å…¶ä»–å¯èƒ½çš„æœºåˆ¶è§£é‡Šï¼Ÿ

#### âœ¨ ç†è®º
- **ç†è®ºæ¨¡åž‹**: ä½¿ç”¨æˆ–å»ºç«‹äº†ä»€ä¹ˆç†è®ºæ¨¡åž‹ï¼Ÿ
- **è®¡ç®—æ–¹æ³•**: å¦‚æ¶‰åŠç†è®ºè®¡ç®—ï¼Œä½¿ç”¨äº†ä»€ä¹ˆæ–¹æ³•ï¼Ÿï¼ˆDFT, MDç­‰ï¼‰
- **ç†è®ºé¢„æµ‹**: ç†è®ºè®¡ç®—æˆ–æ¨¡åž‹é¢„æµ‹äº†ä»€ä¹ˆï¼Ÿ
- **å®žéªŒéªŒè¯**: ç†è®ºé¢„æµ‹æ˜¯å¦å¾—åˆ°å®žéªŒéªŒè¯ï¼Ÿ

---

### ðŸ¤” æ€è€ƒ

#### ä¼˜ç¼ºç‚¹åˆ†æž
- **ä¸»è¦ä¼˜ç‚¹**: è¿™ç¯‡è®ºæ–‡çš„çªå‡ºè´¡çŒ®ï¼ˆè‡³å°‘3ç‚¹ï¼‰
- **ä¸»è¦ç¼ºç‚¹**: å­˜åœ¨çš„é—®é¢˜æˆ–ä¸è¶³ï¼ˆè‡³å°‘2ç‚¹ï¼‰
  - å®žéªŒè®¾è®¡çš„å±€é™æ€§
  - æ•°æ®å®Œæ•´æ€§æˆ–è¯´æœåŠ›çš„æ¬ ç¼º
  - æœºåˆ¶è§£é‡Šçš„ä¸è¶³æˆ–äº‰è®®

#### ç–‘é—®ä¸Žäº‰è®®
- ä½ å¯¹å“ªäº›å†…å®¹äº§ç”Ÿäº†ç–‘é—®ï¼Ÿ
- å“ªäº›ç»“è®ºçš„å¯é æ€§éœ€è¦è¿›ä¸€æ­¥éªŒè¯ï¼Ÿ
- æ˜¯å¦å­˜åœ¨æ›¿ä»£æ€§è§£é‡Šæˆ–äº‰è®®æ€§è§‚ç‚¹ï¼Ÿ

#### ç ”ç©¶å¯å‘
- è¿™ç¯‡è®ºæ–‡ç»™ä½ å¸¦æ¥äº†ä»€ä¹ˆç ”ç©¶å¯å‘ï¼Ÿ
- å¯ä»¥å¦‚ä½•æ”¹è¿›æˆ–æ‰©å±•è¿™é¡¹å·¥ä½œï¼Ÿ
- å¯¹ä½ è‡ªå·±çš„ç ”ç©¶æœ‰ä»€ä¹ˆå€Ÿé‰´æ„ä¹‰ï¼Ÿ

---

### ðŸª¸ é‡ç»„åˆ†å­åŒ–ï¼ˆæ·±åº¦æ‰¹åˆ¤æ€§åˆ†æžï¼‰

è¯·å¯¹è®ºæ–‡çš„é€»è¾‘ä¸¥å¯†æ€§è¿›è¡Œæ‰¹åˆ¤æ€§è¯„ä¼°ï¼š

#### é€»è¾‘é“¾å®Œæ•´æ€§
- å›´ç»•æŸä¸€ä¸ªå®žéªŒçŽ°è±¡çš„é€»è¾‘é“¾æ˜¯å¦**å®Œæ•´**ã€**ä»¤äººä¿¡æœ**ï¼Ÿ
  - ä»Žé—®é¢˜æå‡º â†’ å®žéªŒè®¾è®¡ â†’ æ•°æ®å‘ˆçŽ° â†’ ç»“è®ºæŽ¨å¯¼
  - è®ºè¯è¿‡ç¨‹ä¸­æ˜¯å¦å­˜åœ¨**é€»è¾‘ç¼ºçŽ¯**ï¼Ÿ
  - æ˜¯å¦å­˜åœ¨**å…¶ä»–å¯èƒ½çš„è§£é‡Šè§’åº¦**ï¼Ÿ

#### æ•°æ®å¯ä¿¡åº¦
- å®žéªŒæ•°æ®çš„**å¯é‡å¤æ€§**å¦‚ä½•ï¼Ÿ
- å¯¹ç…§å®žéªŒæ˜¯å¦å……åˆ†ï¼Ÿ
- ç»Ÿè®¡åˆ†æžæ˜¯å¦è§„èŒƒï¼Ÿ
- æ•°æ®æ˜¯å¦æ”¯æŒä½œè€…çš„ç»“è®ºï¼Ÿ

#### ç»“è®ºåˆç†æ€§
- ç»“è®ºæ˜¯å¦**è¶…å‡ºæ•°æ®çš„æ”¯æŒèŒƒå›´**ï¼Ÿ
- æ˜¯å¦å­˜åœ¨**è¿‡åº¦è§£è¯»**æˆ–**è¿‡åº¦æŽ¨å¹¿**ï¼Ÿ
- ä½œè€…çš„æŽ¨æµ‹ä¸Žç¡®å‡¿è¯æ®ä¹‹é—´çš„ç•Œé™æ˜¯å¦æ¸…æ™°ï¼Ÿ

---

## è¾“å‡ºæ ¼å¼è¦æ±‚

1. **ä¿æŒå®¢è§‚ã€ä¸“ä¸šçš„åˆ†æžé£Žæ ¼**ï¼Œé¿å…ä¸»è§‚è‡†æ–­
2. **ä½¿ç”¨ä¸­æ–‡**æ’°å†™åˆ†æžå†…å®¹ï¼Œå…³é”®æœ¯è¯­å¯ç”¨è‹±æ–‡æ ‡æ³¨
3. **æå–å…·ä½“æ•°æ®**ï¼šæ•°å€¼ã€å•ä½ã€æ¡ä»¶ç­‰å…·ä½“ä¿¡æ¯
4. **å¼•ç”¨åŽŸæ–‡**ï¼šé‡è¦ç»“è®ºå¯ä»¥å¼•ç”¨åŽŸæ–‡è¡¨è¿°
5. **æ ‡æ³¨ä¸ç¡®å®šæ€§**ï¼šå¦‚æžœæŸä¸ªéƒ¨åˆ†åœ¨è®ºæ–‡ä¸­æ²¡æœ‰ç›¸å…³å†…å®¹ï¼Œè¯·æ˜Žç¡®æ³¨æ˜Ž"æœ¬æ–‡æœªæ¶‰åŠ"æˆ–"æ•°æ®ä¸è¶³"
6. **ä¿æŒç»“æž„å®Œæ•´**ï¼šå³ä½¿æŸéƒ¨åˆ†å†…å®¹è¾ƒå°‘ï¼Œä¹Ÿè¦ä¿ç•™æ ‡é¢˜ç»“æž„

---

**åˆ†æžç›®æ ‡**: å¸®åŠ©ç ”ç©¶è€…å¿«é€ŸæŠŠæ¡è®ºæ–‡æ ¸å¿ƒå†…å®¹ï¼Œæå–å¯å¼•ç”¨çš„å…³é”®ä¿¡æ¯ï¼Œå‘çŽ°æ½œåœ¨é—®é¢˜å’Œç ”ç©¶æœºä¼šã€‚
"""


DEFAULT_ANALYSIS_TEMPLATE_JSON = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘ç ”æ–‡çŒ®åˆ†æžåŠ©æ‰‹ã€‚è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹è®ºæ–‡å†…å®¹ï¼Œå¹¶æŒ‰ç…§æŒ‡å®šçš„ç»“æž„è¿›è¡Œæ·±å…¥ã€å…¨é¢çš„åˆ†æžã€‚

## è®ºæ–‡åŸºæœ¬ä¿¡æ¯

- **æ ‡é¢˜**: {title}
- **ä½œè€…**: {authors}
- **æœŸåˆŠ**: {journal}
- **å‘è¡¨æ—¥æœŸ**: {date}
- **DOI**: {doi}

## è®ºæ–‡å…¨æ–‡

{fulltext}

{annotations_section}

---

## åˆ†æžè¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›žåˆ†æžç»“æžœã€‚

**âš ï¸ å…³é”®è¦æ±‚**ï¼š
1. **å¿…é¡»ä½¿ç”¨ `{{"sections": [...]}}` æ ¼å¼**
2. **åªåœ¨"âœ¨ ç¬”è®°åŽŸå­åŒ–"éƒ¨åˆ†çš„ bullet_list ä¸­æ·»åŠ  citations å­—æ®µ**
3. **å…¶ä»–éƒ¨åˆ†ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ ¼å¼**

### JSON è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š

```json
{{
  "sections": [
    {{"type": "heading", "level": 3, "text": "ðŸ“– ç²—è¯»ç­›é€‰"}},
    {{"type": "paragraph", "text": "è¯·ä»Žä»¥ä¸‹ç»´åº¦å¿«é€Ÿè¯„ä¼°è¿™ç¯‡è®ºæ–‡çš„è´¨é‡å’Œé˜…è¯»ä»·å€¼ï¼š"}},
    {{"type": "bullet_list", "items": [
      {{"text": "æœŸåˆŠå½±å“åŠ›ï¼šå‘è¡¨åœ¨é¡¶çº§æœŸåˆŠ"}},
      {{"text": "ç ”ç©¶é—®é¢˜é‡è¦æ€§ï¼šèšç„¦å…³é”®ç§‘å­¦é—®é¢˜"}}
    ]}},

    {{"type": "hr"}},

    {{"type": "heading", "level": 3, "text": "âœ¨ ç¬”è®°åŽŸå­åŒ–"}},
    {{"type": "paragraph", "text": "ä»¥ä¸‹éƒ¨åˆ†æå–å…·ä½“æ•°æ®ï¼Œ**æ¯æ¡æ•°æ®å¿…é¡»åŒ…å«åŽŸæ–‡å¼•ç”¨**ï¼š"}},
    {{"type": "heading", "level": 4, "text": "ðŸ”§ åˆ¶å¤‡"}},
    {{"type": "bullet_list", "items": [
      {{
        "text": "åŽŸæ–™ï¼šå‰é©±ä½“A (99.9%)",
        "citations": [
          {{
            "location": "ç¬¬3æ®µ - æ‰€æœ‰åŒ–å­¦è¯•å‰‚å‡è´­è‡ªSigma-Aldrich",
            "content": "æ‰€æœ‰åŒ–å­¦è¯•å‰‚å‡è´­è‡ªSigma-Aldrichï¼Œä½¿ç”¨å‰æœªç»è¿›ä¸€æ­¥çº¯åŒ–ã€‚å‰é©±ä½“A (99.9%) æº¶äºŽåŽ»ç¦»å­æ°´ä¸­..."
          }}
        ]
      }}
    ]}},

    {{"type": "hr"}},

    {{"type": "heading", "level": 3, "text": "ðŸ¤” æ€è€ƒ"}},
    {{"type": "heading", "level": 4, "text": "ä¼˜ç¼ºç‚¹åˆ†æž"}},
    {{"type": "bullet_list", "items": [
      {{"text": "ä¸»è¦ä¼˜ç‚¹ï¼šå®žéªŒè®¾è®¡ä¸¥è°¨ï¼Œæ•°æ®å¯é "}},
      {{"text": "ä¸»è¦ç¼ºç‚¹ï¼šæ ·æœ¬é‡è¾ƒå°"}}
    ]}}
  ]
}}
```

### å¿…é¡»éµå®ˆçš„æ ¼å¼è§„åˆ™ï¼š

1. **é¡¶å±‚å¿…é¡»æ˜¯ `{{"sections": [...]}}`**
2. **heading å­—æ®µç”¨ "text" è€Œä¸æ˜¯ "content"**
3. **paragraph å­—æ®µç”¨ "text" è€Œä¸æ˜¯ "content"**
4. **bullet_list çš„ items æ ¼å¼**ï¼š
   - ä¸éœ€è¦å¼•ç”¨çš„éƒ¨åˆ†ï¼š`{{"text": "å†…å®¹"}}`
   - éœ€è¦å¼•ç”¨çš„éƒ¨åˆ†ï¼ˆä»…ç¬”è®°åŽŸå­åŒ–ï¼‰ï¼š`{{"text": "å†…å®¹", "citations": [...]}}`
5. **hr ä½¿ç”¨ `{{"type": "hr"}}`**

### åˆ†æžç« èŠ‚ï¼š

è¯·æŒ‰é¡ºåºå®Œæˆä»¥ä¸‹æ‰€æœ‰ç« èŠ‚ï¼š
- ðŸ“– ç²—è¯»ç­›é€‰
- ðŸ“š å‰è¨€åŠæ–‡çŒ®ç»¼è¿°ï¼ˆå¼•ç”¨æ–‡çŒ®è¯„ä¼°ã€èšç„¦é—®é¢˜ã€é€‰é¢˜æ–°é¢–æ€§ï¼‰
- ðŸ’¡ åˆ›æ–°ç‚¹ï¼ˆ5ä¸ªç»´åº¦ï¼šç§‘å­¦é—®é¢˜ã€åˆ¶å¤‡æ–¹æ³•ã€ç ”ç©¶æ€è·¯ã€ç ”ç©¶å·¥å…·ã€ç ”ç©¶ç†è®ºï¼‰
- âœ¨ ç¬”è®°åŽŸå­åŒ–ï¼ˆ5ä¸ªå­ç« èŠ‚ï¼šðŸ”§ åˆ¶å¤‡ã€ðŸ“Š è¡¨å¾ã€âš¡ æ€§èƒ½ã€ðŸ”¬ æœºåˆ¶ã€âœ¨ ç†è®ºï¼‰**â† å”¯ä¸€éœ€è¦å¼•ç”¨çš„éƒ¨åˆ†**
- ðŸ¤” æ€è€ƒï¼ˆä¼˜ç¼ºç‚¹åˆ†æžã€ç–‘é—®ä¸Žäº‰è®®ã€ç ”ç©¶å¯å‘ï¼‰
- ðŸª¸ é‡ç»„åˆ†å­åŒ–ï¼ˆé€»è¾‘é“¾å®Œæ•´æ€§ã€æ•°æ®å¯ä¿¡åº¦ã€ç»“è®ºåˆç†æ€§ï¼‰

**è¾“å‡ºè¦æ±‚**ï¼š
- ä½¿ç”¨ markdown ä»£ç å—ï¼š```json ... ```
- ç¡®ä¿ JSON å®Œæ•´ä¸”æœ‰æ•ˆ
- æŽ§åˆ¶æ€»é•¿åº¦åœ¨ 8192 tokens å†…
"""


# -------------------- Theme Configuration --------------------


THEME_PRESETS = {
    "orange-heart": {
        "name": "Typora Orange Heart",
        "primary_color": "rgb(239, 112, 96)",
        "background": "#fff9f9",
        "h2_background": "rgb(239, 112, 96)",
        "h2_color": "#ffffff",
        "link_color": "rgb(239, 112, 96)",
        "code_color": "rgb(239, 112, 96)",
        "code_background": "rgba(27,31,35,0.05)",
        "blockquote_border": "rgb(239, 112, 96)",
        "blockquote_background": "#fff9f9",
        "max_width": "860px",
        "paragraph_margin": "0.2em",
        "list_margin": "0.2em",
        "list_item_margin": "0.2em",
        "h1_margin": "0.8em",
        "h2_margin": "0.8em",
        "h3_margin": "0.6em",
        "h4_margin": "0.6em",
    },
    "default": {
        "name": "Default",
        "primary_color": "#0366d6",
        "background": "#ffffff",
        "h2_background": "#f6f8fa",
        "h2_color": "#24292e",
        "link_color": "#0366d6",
        "code_color": "#0366d6",
        "code_background": "#f6f8fa",
        "blockquote_border": "#dfe2e5",
        "blockquote_background": "#f6f8fa",
        "max_width": "860px",
        "paragraph_margin": "0.8em",
        "list_margin": "1.2em",
        "list_item_margin": "0.4em",
        "h1_margin": "1.5em",
        "h2_margin": "1.5em",
        "h3_margin": "1.3em",
        "h4_margin": "1.2em",
    },
    "minimal": {
        "name": "Minimal",
        "primary_color": "#333333",
        "background": "#ffffff",
        "h2_background": "transparent",
        "h2_color": "#333333",
        "link_color": "#333333",
        "code_color": "#333333",
        "code_background": "#f0f0f0",
        "blockquote_border": "#ddd",
        "blockquote_background": "#ffffff",
        "max_width": "740px",
        "paragraph_margin": "0.6em",
        "list_margin": "1.0em",
        "list_item_margin": "0.3em",
        "h1_margin": "1.2em",
        "h2_margin": "1.2em",
        "h3_margin": "1.0em",
        "h4_margin": "1.0em",
    },
}


# -------------------- Configuration Loading --------------------


def get_analysis_config() -> dict[str, Any]:
    """
    Get AI analysis configuration from environment and config files.

    Returns:
        Dictionary with analysis configuration including:
        - questions: List of analysis questions
        - template: Analysis template string
        - theme: Note theme preset name
        - theme_config: Custom theme configuration (if provided)
    """
    config = load_config()
    env = config.get("env", {})
    analysis_config = config.get("analysis", {})

    # Get questions (priority: env var > config file > default)
    questions_str = env.get("ANALYSIS_QUESTIONS", analysis_config.get("questions", ""))
    if questions_str:
        # Parse questions from JSON string or newline-separated
        try:
            import json

            questions = json.loads(questions_str)
            if not isinstance(questions, list):
                questions = questions_str.split("\n")
        except json.JSONDecodeError:
            questions = [q.strip() for q in questions_str.split("\n") if q.strip()]
    else:
        questions = DEFAULT_ANALYSIS_QUESTIONS

    # Get template (priority: env var > config file > default)
    template = (
        env.get("ANALYSIS_TEMPLATE", analysis_config.get("template", ""))
        or DEFAULT_ANALYSIS_TEMPLATE
    )

    # Get theme (priority: env var > config file > default)
    theme = env.get("NOTE_THEME", analysis_config.get("theme", "orange-heart"))

    # Get custom theme config if provided
    custom_theme_str = env.get("NOTE_THEME_CONFIG", "")
    custom_theme_config = {}
    if custom_theme_str:
        try:
            import json

            custom_theme_config = json.loads(custom_theme_str)
        except json.JSONDecodeError:
            pass

    # Get theme preset
    theme_preset = THEME_PRESETS.get(theme, THEME_PRESETS["orange-heart"])

    # Merge custom theme config with preset
    if custom_theme_config:
        theme_config = {**theme_preset, **custom_theme_config}
    else:
        theme_config = theme_preset

    return {
        "questions": questions,
        "template": template,
        "theme": theme,
        "theme_config": theme_config,
    }


def get_analysis_questions() -> list[str]:
    """
    Get the list of analysis questions.

    Returns:
        List of analysis question strings.
    """
    config = get_analysis_config()
    return config["questions"]


def get_analysis_template() -> str:
    """
    Get the analysis template string.

    Returns:
        Analysis template string.
    """
    config = get_analysis_config()
    return config["template"]


def get_note_theme_config() -> dict[str, str]:
    """
    Get the note theme configuration.

    Returns:
        Dictionary with theme configuration values.
    """
    config = get_analysis_config()
    return config["theme_config"]
